<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç«¶é¦¬ãƒ‡ãƒ¼ã‚¿åˆ†æ Web</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", sans-serif; margin: 0; padding: 0; background: #f2f2f7; color: #333; }
        header { background: #fff; padding: 15px; text-align: center; border-bottom: 1px solid #ccc; position: sticky; top: 0; z-index: 100; }
        h1 { margin: 0; font-size: 1.2rem; }
        .version-tag { font-size: 0.8rem; color: #888; font-weight: normal; margin-left: 5px; }

        .file-area { padding: 15px; background: #fff; margin-bottom: 10px; text-align: center; }
        .status-box { font-size: 0.9rem; color: #666; margin-top: 8px; min-height: 1.5em; font-weight: bold; }
        .status-ready { color: #34c759; }
        .status-busy { color: #007aff; }
        .status-error { color: #ff3b30; }

        .tabs { display: flex; background: #fff; border-bottom: 1px solid #ccc; }
        .tab { flex: 1; padding: 15px; text-align: center; cursor: pointer; color: #888; border-bottom: 3px solid transparent; font-size: 0.9rem; }
        .tab.active { color: #007aff; border-bottom: 3px solid #007aff; font-weight: bold; }
        
        .content { display: none; padding: 15px; }
        .content.active { display: block; }
        
        .filter-group { background: #fff; padding: 15px; border-radius: 10px; margin-bottom: 15px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .filter-row { display: flex; gap: 10px; margin-bottom: 10px; }
        .filter-row:last-child { margin-bottom: 0; }
        select, input[type="text"] { flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 5px; font-size: 1rem; }
        
        /* å®Ÿè¡Œãƒœã‚¿ãƒ³ (NEW) */
        .btn-run { width: 100%; padding: 12px; background: #007aff; color: white; border: none; border-radius: 8px; font-size: 1.1rem; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .btn-run:disabled { background: #ccc; cursor: not-allowed; }

        .record-list { list-style: none; padding: 0; margin: 0; }
        .record-item { background: #fff; padding: 12px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        
        .rank-badge { width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; margin-right: 10px; font-size: 0.9rem; flex-shrink: 0; }
        .rank-1 { background: gold; color: #fff; }
        .rank-2 { background: silver; color: #fff; }
        .rank-3 { background: #cd7f32; color: #fff; }
        .rank-other { background: #eee; color: #333; }
        .horse-name { font-weight: bold; font-size: 1.1rem; display: block; }
        .meta-info { font-size: 0.8rem; color: #666; }
        .time-str { font-weight: bold; font-size: 1.2rem; font-family: monospace; }
        .condition { font-size: 0.7rem; color: #999; }
        .outlier { color: red; }
        .ref-text { color: red; font-size: 0.7rem; }

        /* ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ */
        .progress-container { width: 100%; background-color: #eee; border-radius: 5px; margin-top: 5px; display: none; }
        .progress-bar { width: 0%; height: 5px; background-color: #007aff; border-radius: 5px; transition: width 0.1s; }

        .update-box { text-align: center; padding: 20px; border: 2px dashed #ccc; border-radius: 10px; background: #fafafa; margin-bottom: 20px; }
        .btn-danger { background: #ff3b30; color: white; border: none; padding: 8px 15px; border-radius: 5px; font-size: 0.8rem; cursor: pointer; margin-top: 5px; }
    </style>
</head>
<body>

<header>
    <h1>ç«¶é¦¬ãƒ‡ãƒ¼ã‚¿åˆ†æ Web <span class="version-tag">v2.0 (Stream)</span></h1>
</header>

<div class="file-area">
    <label for="csvFile" style="font-weight:bold;">CSVãƒ•ã‚¡ã‚¤ãƒ«ã®é¸æŠ</label><br>
    <div style="font-size:0.7rem; color:#888; margin-bottom:5px;">(â€»ãƒ•ã‚¡ã‚¤ãƒ«ã¯å†…éƒ¨DBã«ä¿å­˜ã•ã‚Œã€éƒ½åº¦èª­ã¿å‡ºã•ã‚Œã¾ã™)</div>
    <input type="file" id="csvFile" accept=".csv">
    
    <div id="statusBox" class="status-box">ãƒ•ã‚¡ã‚¤ãƒ«æœªé¸æŠ</div>
    <div id="progressContainer" class="progress-container"><div id="progressBar" class="progress-bar"></div></div>
    
    <button id="clearBtn" class="btn-danger" style="display:none;" onclick="clearDB()">ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤</button>
</div>

<div class="tabs">
    <div class="tab active" onclick="switchTab('ranking')">ãƒ©ãƒ³ã‚­ãƒ³ã‚°</div>
    <div class="tab" onclick="switchTab('search')">é¦¬åæ¤œç´¢</div>
    <div class="tab" onclick="switchTab('update')">ãƒ‡ãƒ¼ã‚¿æ›´æ–°</div>
</div>

<div id="ranking" class="content active">
    <div class="filter-group">
        <div style="font-size:0.8rem; color:#007aff; margin-bottom:5px;">â–¼ æ¡ä»¶ã‚’æŒ‡å®šã—ã¦æ¤œç´¢ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„</div>
        <div class="filter-row">
            <select id="placeSelect">
                <option value="å…¨ã¦">å ´æ‰€: å…¨ã¦</option>
                <option value="æ±äº¬">æ±äº¬</option><option value="ä¸­å±±">ä¸­å±±</option>
                <option value="äº¬éƒ½">äº¬éƒ½</option><option value="é˜ªç¥">é˜ªç¥</option>
                <option value="ãã®ä»–">ãã®ä»–</option>
            </select>
            <select id="trackSelect">
                <option value="èŠ" selected>èŠ</option>
                <option value="ãƒ€ãƒ¼ãƒˆ">ãƒ€ãƒ¼ãƒˆ</option><option value="éšœå®³">éšœå®³</option>
            </select>
        </div>
        <div class="filter-row">
            <select id="distSelect">
                <option value="1200">1200m</option><option value="1400">1400m</option>
                <option value="1600" selected>1600m</option><option value="1800">1800m</option>
                <option value="2000">2000m</option><option value="2400">2400m</option>
            </select>
            <label style="display:flex; align-items:center; font-size:0.8rem;">
                <input type="checkbox" id="outlierCheck" checked> å‚è€ƒè¨˜éŒ²è¾¼
            </label>
        </div>
        <button id="rankBtn" class="btn-run" onclick="runRanking()" disabled>ğŸ” ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’è¡¨ç¤º</button>
    </div>
    <div id="rankingList" class="record-list">
        <div style="text-align:center; color:#999; padding:20px;">æ¡ä»¶ã‚’æŒ‡å®šã—ã¦å®Ÿè¡Œã—ã¦ãã ã•ã„</div>
    </div>
</div>

<div id="search" class="content">
    <div class="filter-group">
        <div class="filter-row">
            <input type="text" id="searchInput" placeholder="é¦¬åã‚’å…¥åŠ› (ä¾‹: ãƒ‰ã‚¦ãƒ‡ãƒ¥ãƒ¼ã‚¹)">
        </div>
        <button id="searchBtn" class="btn-run" onclick="runSearch()" disabled>ğŸ´ é¦¬åã§æ¤œç´¢</button>
    </div>
    <div id="searchList" class="record-list"></div>
</div>

<div id="update" class="content">
    <div class="filter-group">
        <h3>ãƒ‡ãƒ¼ã‚¿è¿½åŠ </h3>
        <p style="font-size:0.9rem; color:#666;">
            æ–°ã—ã„CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã™ã‚‹ã¨ã€æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã«è¿½è¨˜ã•ã‚Œã¾ã™ã€‚<br>
            (â€»å·¨å¤§ãªãƒ•ã‚¡ã‚¤ãƒ«ã®å ´åˆã€å‡¦ç†ã«æ™‚é–“ãŒã‹ã‹ã‚Šã¾ã™)
        </p>
        <div class="update-box">
            <input type="file" id="updateFile" accept=".csv">
        </div>
        <div id="updateStatus" style="color:#007aff; font-weight:bold;"></div>
    </div>
</div>

<script>
    // --- Workerç”¨ã‚³ãƒ¼ãƒ‰ (åˆ¥ã‚¹ãƒ¬ãƒƒãƒ‰ã§CSVã‚’ä¸€è¡Œãšã¤å‡¦ç†ã™ã‚‹) ---
    // BlobURLã¨ã—ã¦ç”Ÿæˆã™ã‚‹ãŸã‚ã€ã“ã“ã«æ–‡å­—åˆ—ã¨ã—ã¦è¨˜è¿°
    const workerScript = `
    importScripts('https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js');

    onmessage = function(e) {
        const { type, file, filters } = e.data;
        
        if (type === 'RANKING') {
            processRanking(file, filters);
        } else if (type === 'SEARCH') {
            processSearch(file, filters);
        } else if (type === 'MERGE') {
            // ãƒãƒ¼ã‚¸ã¯è¤‡é›‘ãªãŸã‚ã€ä»Šå›ã¯ã€Œè¿½åŠ ã€ã§ã¯ãªãã€Œå·®ã—æ›¿ãˆã€ã‚’æ¨å¥¨
            // ã‚‚ã—å®Ÿè£…ã™ã‚‹ãªã‚‰ã“ã“ã§ã€‚ä»Šå›ã¯UIå´ã§åˆ¶å¾¡ã€‚
        }
    };

    function processRanking(file, filters) {
        const results = [];
        const limit = 100; // ä¸Šä½100ä»¶
        let count = 0;
        const totalSize = file.size;
        let processedSize = 0;

        Papa.parse(file, {
            header: true,
            skipEmptyLines: true,
            chunk: function(resultsChunk, parser) {
                const rows = resultsChunk.data;
                processedSize += resultsChunk.meta.cursor || 0; // é€²æ—è¨ˆç®—ç”¨(æ¦‚ç®—)
                
                // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°å‡¦ç†
                for (let i = 0; i < rows.length; i++) {
                    const r = rows[i];
                    if (!r.race_id) continue;

                    // æ¡ä»¶åˆ¤å®š
                    // å ´æ‰€
                    if (filters.place !== 'å…¨ã¦' && r.place !== filters.place) continue;
                    // ãƒˆãƒ©ãƒƒã‚¯
                    if (r.track !== filters.track) continue;
                    // è·é›¢ (æ•°å€¤å¤‰æ›ã—ã¦æ¯”è¼ƒ)
                    if (parseInt(r.distance) !== filters.dist) continue;
                    // å‚è€ƒè¨˜éŒ²
                    const isOut = (r.is_outlier === 'True' || r.is_outlier === 'true');
                    if (!filters.showOutlier && isOut) continue;

                    // ãƒãƒƒãƒã—ãŸã‚‰æ ¼ç´ (å¿…è¦ãªæƒ…å ±ã ã‘)
                    results.push({
                        horse_name: r.horse_name,
                        date: r.date,
                        place: r.place,
                        track: r.track,
                        distance: r.distance,
                        time_str: r.time_str,
                        seconds: parseFloat(r.seconds) || 9999,
                        condition: r.condition,
                        rank: r.rank,
                        is_outlier: isOut
                    });
                }
                
                // é€²æ—é€šçŸ¥ (ã‚ã¾ã‚Šé »ç¹ã ã¨é‡ããªã‚‹ã®ã§é©åº¦ã«)
                // postMessage({ type: 'PROGRESS', percent: ... });
            },
            complete: function() {
                // ã‚½ãƒ¼ãƒˆ (ã‚¿ã‚¤ãƒ é †)
                results.sort((a, b) => a.seconds - b.seconds);
                // ä¸Šä½ã®ã¿è¿”ã™
                const topResults = results.slice(0, limit);
                postMessage({ type: 'RESULT', data: topResults });
            },
            error: function(err) {
                postMessage({ type: 'ERROR', msg: err.message });
            }
        });
    }

    function processSearch(file, filters) {
        const results = [];
        const query = filters.query;
        if(!query) {
            postMessage({ type: 'RESULT', data: [] });
            return;
        }

        Papa.parse(file, {
            header: true,
            skipEmptyLines: true,
            chunk: function(resultsChunk) {
                const rows = resultsChunk.data;
                for (let i = 0; i < rows.length; i++) {
                    const r = rows[i];
                    if (!r.horse_name) continue;
                    
                    if (r.horse_name.includes(query)) {
                        results.push(r);
                    }
                }
            },
            complete: function() {
                // æ—¥ä»˜é †ã‚½ãƒ¼ãƒˆ (é™é †: æ–°ã—ã„é †)
                results.sort((a, b) => (a.date < b.date ? 1 : -1));
                postMessage({ type: 'RESULT', data: results });
            }
        });
    }
    `;

    // --- ãƒ¡ã‚¤ãƒ³ã‚¹ãƒ¬ãƒƒãƒ‰å‡¦ç† ---
    const DB_NAME = 'KeibaLargeDB';
    const STORE_NAME = 'files';
    let db;
    let worker;
    let currentFile = null; // ãƒ¡ãƒ¢ãƒªä¸Šã«ã¯æŒãŸãšã€DBã‹ã‚‰å–ã£ãŸFileã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ã¿ä¿æŒ

    // èµ·å‹•æ™‚
    window.onload = function() {
        initWorker();
        openDB();
    };

    function initWorker() {
        const blob = new Blob([workerScript], { type: 'application/javascript' });
        worker = new Worker(URL.createObjectURL(blob));
        
        worker.onmessage = function(e) {
            const msg = e.data;
            if (msg.type === 'RESULT') {
                hideProgress();
                if (window.currentAction === 'RANKING') renderRanking(msg.data);
                if (window.currentAction === 'SEARCH') renderSearch(msg.data);
            } else if (msg.type === 'ERROR') {
                hideProgress();
                alert("ã‚¨ãƒ©ãƒ¼: " + msg.msg);
            }
        };
    }

    // --- IndexedDB (ãƒ•ã‚¡ã‚¤ãƒ«ãã®ã‚‚ã®ã‚’Blobã¨ã—ã¦ä¿å­˜) ---
    function openDB() {
        const req = indexedDB.open(DB_NAME, 1);
        req.onupgradeneeded = function(e) {
            db = e.target.result;
            db.createObjectStore(STORE_NAME); // ã‚­ãƒ¼ã¯ "main" å›ºå®š
        };
        req.onsuccess = function(e) {
            db = e.target.result;
            checkDB();
        };
        req.onerror = e => console.error(e);
    }

    function checkDB() {
        const tx = db.transaction([STORE_NAME], 'readonly');
        const req = tx.objectStore(STORE_NAME).get('mainCSV');
        req.onsuccess = function(e) {
            if (e.target.result) {
                // ãƒ•ã‚¡ã‚¤ãƒ«(Blob)ãŒè¦‹ã¤ã‹ã£ãŸ
                currentFile = e.target.result; 
                document.getElementById('statusBox').innerText = `ãƒ‡ãƒ¼ã‚¿æº–å‚™å®Œäº† (${(currentFile.size / 1024 / 1024).toFixed(1)} MB)`;
                document.getElementById('statusBox').className = "status-box status-ready";
                document.getElementById('clearBtn').style.display = "inline-block";
                enableButtons(true);
            } else {
                document.getElementById('statusBox').innerText = "ãƒ‡ãƒ¼ã‚¿æœªç™»éŒ² (CSVã‚’é¸æŠã—ã¦ãã ã•ã„)";
                enableButtons(false);
            }
        };
    }

    function saveFileToDB(file) {
        showProgress(true); // æ“¬ä¼¼çš„ã«è¡¨ç¤º
        const tx = db.transaction([STORE_NAME], 'readwrite');
        const req = tx.objectStore(STORE_NAME).put(file, 'mainCSV');
        req.onsuccess = function() {
            hideProgress();
            currentFile = file;
            document.getElementById('statusBox').innerText = `ä¿å­˜å®Œäº†: ${(file.size / 1024 / 1024).toFixed(1)} MB`;
            document.getElementById('statusBox').className = "status-box status-ready";
            document.getElementById('clearBtn').style.display = "inline-block";
            enableButtons(true);
            alert("ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚ã“ã‚Œã§ã„ã¤ã§ã‚‚æ¤œç´¢ã§ãã¾ã™ã€‚");
        };
        req.onerror = function() {
            hideProgress();
            alert("ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚HDDå®¹é‡ä¸è¶³ã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚");
        };
    }

    function clearDB() {
        if(!confirm("ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
        const tx = db.transaction([STORE_NAME], 'readwrite');
        tx.objectStore(STORE_NAME).delete('mainCSV');
        location.reload();
    }

    // --- UIæ“ä½œ ---
    document.getElementById('csvFile').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if(!file) return;
        // å³åº§ã«DBã¸ä¿å­˜
        saveFileToDB(file);
    });

    // è¿½è¨˜ï¼ˆä»Šå›ã¯ç°¡æ˜“çš„ã«ã€Œä¸Šæ›¸ãã€ã¨ã—ã¦æ‰±ã†ã‹ã€è­¦å‘Šã‚’å‡ºã™ï¼‰
    // 185MBã«å¯¾ã—ã¦JSã§è¿½è¨˜å‡¦ç†ã‚’ã™ã‚‹ã¨ãƒ–ãƒ©ã‚¦ã‚¶ãŒæ­»ã¬ãŸã‚ã€PCå´ã§çµåˆã™ã‚‹ã“ã¨ã‚’æ¨å¥¨ã™ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«å¤‰æ›´
    document.getElementById('updateFile').addEventListener('change', function(e) {
        alert("ã€æ³¨æ„ã€‘å·¨å¤§ãªãƒ‡ãƒ¼ã‚¿ã«å¯¾ã™ã‚‹ãƒ–ãƒ©ã‚¦ã‚¶ä¸Šã§ã®è¿½è¨˜ãƒ»çµåˆã¯ã‚¯ãƒ©ãƒƒã‚·ãƒ¥ã®åŸå› ã«ãªã‚Šã¾ã™ã€‚\n\næ–°ã—ã„å®Œå…¨ãªCSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã€Œãƒ¡ã‚¤ãƒ³ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã€ã‹ã‚‰å†ç™»éŒ²ã™ã‚‹ã“ã¨ã‚’æ¨å¥¨ã—ã¾ã™ã€‚");
        this.value = ""; // ãƒªã‚»ãƒƒãƒˆ
    });

    function enableButtons(enabled) {
        document.getElementById('rankBtn').disabled = !enabled;
        document.getElementById('searchBtn').disabled = !enabled;
    }

    function showProgress(indeterminate = true) {
        const c = document.getElementById('progressContainer');
        const b = document.getElementById('progressBar');
        c.style.display = 'block';
        if (indeterminate) {
            b.style.width = '50%'; // ç°¡æ˜“è¡¨ç¤º
            b.classList.add('status-busy');
        }
    }
    function hideProgress() {
        document.getElementById('progressContainer').style.display = 'none';
    }

    // --- å®Ÿè¡Œå‡¦ç† ---
    function runRanking() {
        if (!currentFile) return;
        window.currentAction = 'RANKING';
        
        const filters = {
            place: document.getElementById('placeSelect').value,
            track: document.getElementById('trackSelect').value,
            dist: parseInt(document.getElementById('distSelect').value),
            showOutlier: document.getElementById('outlierCheck').checked
        };

        document.getElementById('rankingList').innerHTML = '<div style="text-align:center; padding:20px; color:#007aff;">æ¤œç´¢ä¸­... (æ•°ç§’ã‹ã‹ã‚Šã¾ã™)</div>';
        showProgress();
        
        worker.postMessage({ type: 'RANKING', file: currentFile, filters: filters });
    }

    function runSearch() {
        if (!currentFile) return;
        window.currentAction = 'SEARCH';
        
        const query = document.getElementById('searchInput').value;
        if (!query) { alert("é¦¬åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }

        document.getElementById('searchList').innerHTML = '<div style="text-align:center; padding:20px; color:#007aff;">å…¨ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰æ¤œç´¢ä¸­...</div>';
        showProgress();

        worker.postMessage({ type: 'SEARCH', file: currentFile, filters: { query: query } });
    }

    // --- æç”» ---
    function renderRanking(data) {
        const c = document.getElementById('rankingList');
        c.innerHTML = '';
        if (data.length === 0) { c.innerHTML = '<div style="text-align:center; padding:20px;">è©²å½“ãªã—</div>'; return; }

        data.forEach((r, i) => {
            const div = document.createElement('div');
            div.className = 'record-item';
            
            let rc = 'rank-other';
            if (i===0) rc='rank-1'; else if(i===1) rc='rank-2'; else if(i===2) rc='rank-3';
            
            div.innerHTML = `
                <div style="display:flex;align-items:center;">
                    <div class="rank-badge ${rc}">${i+1}</div>
                    <div><span class="horse-name">${r.horse_name}</span>
                    <div class="meta-info">${r.date} (${r.place}) <b>${r.track}${r.distance}m</b></div></div>
                </div>
                <div style="text-align:right;">
                    <div class="time-str ${r.is_outlier?'outlier':''}">${r.time_str}</div>
                    <div class="condition">${r.condition} / ${r.rank}ç€</div>
                </div>`;
            c.appendChild(div);
        });
    }

    function renderSearch(data) {
        const c = document.getElementById('searchList');
        c.innerHTML = '';
        if (data.length === 0) { c.innerHTML = '<div style="text-align:center; padding:20px;">è©²å½“ãªã—</div>'; return; }

        data.forEach(r => {
            const div = document.createElement('div');
            div.className = 'record-item';
            div.innerHTML = `
                <div><span class="horse-name">${r.horse_name}</span>
                <div class="meta-info">${r.date} (${r.place}) ${r.track}${r.distance}m</div></div>
                <div style="text-align:right;">
                    <div class="time-str">${r.time_str}</div>
                    <div class="condition">${r.condition} / ${r.rank}ç€</div>
                </div>`;
            c.appendChild(div);
        });
    }

    function switchTab(n) {
        document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
        document.querySelectorAll('.content').forEach(c=>c.classList.remove('active'));
        document.getElementById(n).classList.add('active');
        // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆãƒ­ã‚¸ãƒƒã‚¯
        const tabs = document.querySelectorAll('.tab');
        if(n==='ranking') tabs[0].classList.add('active');
        else if(n==='search') tabs[1].classList.add('active');
        else tabs[2].classList.add('active');
    }
</script>
</body>
</html>