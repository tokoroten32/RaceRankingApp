<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç«¶é¦¬ãƒ‡ãƒ¼ã‚¿åˆ†æ Web</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", sans-serif; margin: 0; padding: 0; background: #f2f2f7; color: #333; }
        header { background: #fff; padding: 15px; text-align: center; border-bottom: 1px solid #ccc; position: sticky; top: 0; z-index: 100; }
        h1 { margin: 0; font-size: 1.2rem; }
        
        /* ãƒãƒ¼ã‚¸ãƒ§ãƒ³è¡¨ç¤ºç”¨ã‚¹ã‚¿ã‚¤ãƒ« (NEW) */
        .version-tag { font-size: 0.8rem; color: #888; font-weight: normal; margin-left: 5px; }

        .file-area { padding: 15px; background: #fff; margin-bottom: 10px; text-align: center; }
        .status-box { font-size: 0.8rem; color: #666; margin-top: 8px; min-height: 1.2em; }
        .status-success { color: #34c759; font-weight: bold; }
        .status-loading { color: #007aff; }
        .status-error { color: #ff3b30; font-weight: bold; }
        
        .period-area { margin-top: 15px; padding-top: 15px; border-top: 1px dashed #ccc; display: none; }
        .period-area.visible { display: block; }
        .period-control { display: flex; justify-content: center; align-items: center; gap: 5px; margin-top: 5px; }
        .period-select { padding: 5px; border: 1px solid #ddd; border-radius: 5px; font-size: 1rem; width: auto; }

        .tabs { display: flex; background: #fff; border-bottom: 1px solid #ccc; }
        .tab { flex: 1; padding: 15px; text-align: center; cursor: pointer; color: #888; border-bottom: 3px solid transparent; font-size: 0.9rem; }
        .tab.active { color: #007aff; border-bottom: 3px solid #007aff; font-weight: bold; }
        
        .content { display: none; padding: 15px; }
        .content.active { display: block; }
        
        .filter-group { background: #fff; padding: 15px; border-radius: 10px; margin-bottom: 15px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .filter-row { display: flex; gap: 10px; margin-bottom: 10px; }
        .filter-row:last-child { margin-bottom: 0; }
        select, input[type="text"] { flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 5px; font-size: 1rem; }
        
        .record-list { list-style: none; padding: 0; margin: 0; }
        .record-item { background: #fff; padding: 12px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .record-item:last-child { border-bottom: none; }
        
        .rank-badge { width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; margin-right: 10px; font-size: 0.9rem; flex-shrink: 0; }
        .rank-1 { background: gold; color: #fff; }
        .rank-2 { background: silver; color: #fff; }
        .rank-3 { background: #cd7f32; color: #fff; }
        .rank-other { background: #eee; color: #333; }
        .horse-name { font-weight: bold; font-size: 1.1rem; display: block; }
        .meta-info { font-size: 0.8rem; color: #666; }
        .time-str { font-weight: bold; font-size: 1.2rem; font-family: monospace; }
        .condition { font-size: 0.7rem; color: #999; }
        .outlier { color: red; }
        .ref-text { color: red; font-size: 0.7rem; }
        
        .search-box { display: flex; gap: 5px; }
        .selected-horses-area { background: #fff; padding: 10px; border-radius: 10px; margin-bottom: 15px; }
        .tag-container { display: flex; flex-wrap: wrap; gap: 5px; margin-bottom: 10px; }
        .horse-tag { background: #e0f0ff; color: #007aff; padding: 5px 10px; border-radius: 15px; font-size: 0.9rem; display: flex; align-items: center; gap: 5px; border: 1px solid #007aff; }
        .remove-btn { cursor: pointer; font-weight: bold; }
        .btn-compare { width: 100%; padding: 10px; background: #007aff; color: white; border: none; border-radius: 8px; font-size: 1rem; cursor: pointer; }
        .btn-add { background: none; border: none; color: #007aff; font-size: 1.5rem; cursor: pointer; }
        .check-icon { color: #007aff; font-size: 1.2rem; }
        .hidden { display: none !important; }

        .update-box { text-align: center; padding: 20px; border: 2px dashed #ccc; border-radius: 10px; background: #fafafa; margin-bottom: 20px; }
        
        .btn-primary { background: #007aff; color: white; border: none; padding: 10px 20px; border-radius: 8px; font-size: 1.1rem; cursor: pointer; font-weight: bold; width: 100%; margin-bottom: 10px; transition: background 0.3s; }
        .btn-primary:disabled { background: #ccc; cursor: not-allowed; }
        
        .btn-secondary { background: #8e8e93; color: white; border: none; padding: 10px 20px; border-radius: 8px; font-size: 0.9rem; cursor: pointer; }
        .btn-danger { background: #ff3b30; color: white; border: none; padding: 8px 15px; border-radius: 5px; font-size: 0.8rem; cursor: pointer; margin-top: 5px; }
        
        .script-area { text-align: left; margin-bottom: 20px; }
        .code-box { width: 100%; height: 100px; font-family: monospace; font-size: 0.8rem; border: 1px solid #ddd; border-radius: 5px; padding: 5px; background: #f0f0f0; color: #555; box-sizing: border-box; resize: vertical; }
        .btn-copy { background: #5856d6; color: white; border: none; padding: 8px 15px; border-radius: 5px; font-size: 0.9rem; cursor: pointer; margin-right: 5px; }
        .btn-colab { background: #f9ab00; color: white; border: none; padding: 8px 15px; border-radius: 5px; font-size: 0.9rem; cursor: pointer; text-decoration: none; display: inline-block; }

    </style>
</head>
<body>

<header>
    <h1>ç«¶é¦¬ãƒ‡ãƒ¼ã‚¿åˆ†æ Web <span id="appVersion" class="version-tag"></span></h1>
</header>

<div class="file-area">
    <label for="csvFile" style="font-weight:bold;">ãƒ¡ã‚¤ãƒ³ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿</label><br>
    <div style="font-size:0.7rem; color:#888; margin-bottom:5px;">(â€»é€šå¸¸ã¯è‡ªå‹•ã§èª­ã¿è¾¼ã¾ã‚Œã¾ã™)</div>
    <input type="file" id="csvFile" accept=".csv">
    <div id="fileStatus" class="status-box">ãƒ‡ãƒ¼ã‚¿æœªãƒ­ãƒ¼ãƒ‰</div>
    <div id="clearDataArea" class="hidden">
        <button class="btn-danger" onclick="clearDB()">ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¦ãƒªã‚»ãƒƒãƒˆ</button>
    </div>

    <div id="periodFilterArea" class="period-area">
        <div style="font-size:0.8rem; font-weight:bold; color:#007aff;">â–¼ å¯¾è±¡æœŸé–“ã®è¨­å®š</div>
        <div class="period-control">
            <select id="startYear" class="period-select" onchange="applyDateFilter()"></select>
            <span>å¹´</span>
            <select id="startMonth" class="period-select" onchange="applyDateFilter()">
                <option value="1">1</option><option value="2">2</option><option value="3">3</option>
                <option value="4">4</option><option value="5">5</option><option value="6">6</option>
                <option value="7">7</option><option value="8">8</option><option value="9">9</option>
                <option value="10">10</option><option value="11">11</option><option value="12">12</option>
            </select>
            <span>æœˆ ã€œ æœ€æ–°</span>
        </div>
        <div id="periodCount" style="font-size:0.7rem; color:#666; margin-top:5px;"></div>
    </div>
</div>

<div class="tabs">
    <div class="tab active" onclick="switchTab('ranking')">ãƒ©ãƒ³ã‚­ãƒ³ã‚°</div>
    <div class="tab" onclick="switchTab('search')">é¦¬æ¤œç´¢ãƒ»æ¯”è¼ƒ</div>
    <div class="tab" onclick="switchTab('update')">ãƒ‡ãƒ¼ã‚¿è¿½åŠ </div>
</div>

<div id="ranking" class="content active">
    <div class="filter-group">
        <div class="filter-row">
            <select id="placeSelect" onchange="updateRanking()">
                <option value="å…¨ã¦">å ´æ‰€: å…¨ã¦</option>
                <option value="æ±äº¬">æ±äº¬</option>
                <option value="ä¸­å±±">ä¸­å±±</option>
                <option value="äº¬éƒ½">äº¬éƒ½</option>
                <option value="é˜ªç¥">é˜ªç¥</option>
                <option value="ãã®ä»–">ãã®ä»–</option>
            </select>
            <select id="trackSelect" onchange="updateRanking()">
                <option value="èŠ" selected>èŠ</option>
                <option value="ãƒ€ãƒ¼ãƒˆ">ãƒ€ãƒ¼ãƒˆ</option>
                <option value="éšœå®³">éšœå®³</option>
            </select>
        </div>
        <div class="filter-row">
            <select id="distSelect" onchange="updateRanking()">
                <option value="1200">1200m</option>
                <option value="1400">1400m</option>
                <option value="1600" selected>1600m</option>
                <option value="1800">1800m</option>
                <option value="2000">2000m</option>
                <option value="2400">2400m</option>
            </select>
            <label style="display:flex; align-items:center; font-size:0.8rem;">
                <input type="checkbox" id="outlierCheck" onchange="updateRanking()" checked> å‚è€ƒè¨˜éŒ²è¾¼
            </label>
        </div>
    </div>
    <div id="rankingList" class="record-list">
        <div style="text-align:center; color:#999; padding:20px;">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„</div>
    </div>
</div>

<div id="search" class="content">
    <div class="filter-group">
        <div class="search-box">
            <input type="text" id="searchInput" placeholder="é¦¬åã‚’å…¥åŠ› (ä¾‹: ãƒ‰ã‚¦ãƒ‡ãƒ¥ãƒ¼ã‚¹)" oninput="searchHorse()">
        </div>
    </div>
    <div class="selected-horses-area" id="selectedArea" style="display:none;">
        <div style="font-size:0.8rem; color:gray; margin-bottom:5px;">é¸æŠä¸­ã®é¦¬</div>
        <div class="tag-container" id="selectedTags"></div>
        <button class="btn-compare" onclick="showComparison()">ã“ã®ãƒ¡ãƒ³ãƒãƒ¼ã®å±¥æ­´ã‚’æ¯”è¼ƒ</button>
    </div>
    <div id="searchFilterArea" class="filter-group hidden">
        <div style="font-size:0.8rem; color:#007aff; margin-bottom:8px; font-weight:bold;">â–¼ çµã‚Šè¾¼ã¿æ¡ä»¶</div>
        <div class="filter-row">
            <select id="s_placeSelect" onchange="updateComparison()">
                <option value="å…¨ã¦" selected>å ´æ‰€: å…¨ã¦</option>
                <option value="æ±äº¬">æ±äº¬</option>
                <option value="ä¸­å±±">ä¸­å±±</option>
                <option value="äº¬éƒ½">äº¬éƒ½</option>
                <option value="é˜ªç¥">é˜ªç¥</option>
                <option value="ãã®ä»–">ãã®ä»–</option>
            </select>
            <select id="s_trackSelect" onchange="updateComparison()">
                <option value="å…¨ã¦" selected>ãƒˆãƒ©ãƒƒã‚¯: å…¨ã¦</option>
                <option value="èŠ">èŠ</option>
                <option value="ãƒ€ãƒ¼ãƒˆ">ãƒ€ãƒ¼ãƒˆ</option>
                <option value="éšœå®³">éšœå®³</option>
            </select>
        </div>
        <div class="filter-row">
            <select id="s_distSelect" onchange="updateComparison()">
                <option value="å…¨ã¦" selected>è·é›¢: å…¨ã¦</option>
                <option value="1200">1200m</option>
                <option value="1400">1400m</option>
                <option value="1600">1600m</option>
                <option value="1800">1800m</option>
                <option value="2000">2000m</option>
                <option value="2400">2400m</option>
            </select>
            <label style="display:flex; align-items:center; font-size:0.8rem;">
                <input type="checkbox" id="s_outlierCheck" onchange="updateComparison()" checked> å‚è€ƒè¨˜éŒ²è¾¼
            </label>
        </div>
    </div>
    <div id="searchResultTitle" style="margin: 10px 0; font-weight:bold; display:none;">æ¤œç´¢çµæœ</div>
    <div id="searchList" class="record-list"></div>
</div>

<div id="update" class="content">
    <div class="filter-group">
        <h3 style="margin-top:0;">1. æ–°ãƒ‡ãƒ¼ã‚¿ã®å–å¾—</h3>
        <p style="font-size:0.9rem; color:#666;">
            Google Colabã§ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã—ã€CSV(ä¾‹: new_data.csv)ã‚’å–å¾—ã—ã¾ã™ã€‚
        </p>
        <div class="script-area">
            <textarea id="pythonCode" class="code-box" readonly></textarea>
            <div style="margin-top:5px; text-align:center;">
                <button class="btn-copy" onclick="copyScript()">ğŸ“‹ ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼</button>
                <a href="https://colab.research.google.com/" target="_blank" class="btn-colab">ğŸš€ Colabã‚’é–‹ã</a>
            </div>
        </div>
    </div>
    <div class="filter-group">
        <h3 style="margin-top:0;">2. æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã«è¿½è¨˜</h3>
        <p style="font-size:0.9rem; color:#666;">
            æ–°ã—ãå–å¾—ã—ãŸCSVã‚’é¸æŠã—ã€ã€Œã‚¢ãƒ—ãƒªå†…ã«ä¿å­˜ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚<br>
            <span style="color:#007aff; font-weight:bold;">ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ä¸è¦ã§ã€ãã®ã¾ã¾ä½¿ãˆã¾ã™ã€‚</span>
        </p>
        <div class="update-box">
            <label style="display:block; margin-bottom:10px; font-weight:bold;">è¿½åŠ ã™ã‚‹CSV (new_data.csv)</label>
            <input type="file" id="updateFile" accept=".csv">
        </div>
        <div id="updateResult" style="margin-bottom:20px; font-weight:bold; color:#007aff;"></div>
        <div id="mergeActionArea" class="hidden">
            <button id="saveInternalBtn" class="btn-primary" onclick="saveMergedToDB()">
                ğŸ’¾ è¿½è¨˜ã—ã¦ã‚¢ãƒ—ãƒªå†…ã«ä¿å­˜<br>
                <span style="font-size:0.8rem; font-weight:normal;">(æ¬¡å›ã‹ã‚‰ã“ã®ãƒ‡ãƒ¼ã‚¿ãŒé–‹ãã¾ã™)</span>
            </button>
            <div style="margin-top:15px; border-top:1px solid #eee; padding-top:15px;">
                <p style="font-size:0.8rem; color:#666;">ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãŒå¿…è¦ãªå ´åˆã®ã¿:</p>
                <button id="downloadBtn" class="btn-secondary" onclick="downloadMergedCSV()">
                    CSVãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦æ›¸ãå‡ºã—
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    // â˜…ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†ï¼ˆå¤‰æ›´æ™‚ã¯ã“ã“ã‚’æ›¸ãæ›ãˆã‚‹ï¼‰
    const APP_VERSION = "v1.1";

    // --- å¤‰æ•°å®šç¾© ---
    let allRecords = [];      
    let activeRecords = [];   
    let csvHeaders = []; 
    let rawRecords = [];      
    let selectedHorses = new Set(); 
    let isComparisonMode = false;
    let mergedContent = ""; 
    const DB_NAME = 'KeibaAppDB';
    const DB_VERSION = 1;
    const STORE_NAME = 'csvStore';
    let db;

    // --- Colabç”¨ã‚¹ã‚¯ãƒªãƒ—ãƒˆ ---
    const pythonScriptContent = `# Google Colabç”¨ ç«¶é¦¬ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
import requests
from bs4 import BeautifulSoup
import pandas as pd
import time
import re
import random
import os
from google.colab import files

# ========== è¨­å®šã‚¨ãƒªã‚¢ ==========
TARGET_YEAR = 2025  # å–å¾—ã—ãŸã„å¹´
TARGET_MONTH = 1    # å–å¾—ã—ãŸã„æœˆ
SKIP_FILENAME = "skipped_ids.txt"
# ==============================

USER_AGENTS = [
    "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/115.0.0.0 Safari/537.36",
    "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/115.0.0.0 Safari/537.36"
]

def get_html(url):
    try:
        headers = {"User-Agent": random.choice(USER_AGENTS)}
        res = requests.get(url, headers=headers, timeout=30)
        res.encoding = "euc-jp"
        return BeautifulSoup(res.text, "html.parser")
    except: return None

def get_race_ids(year, month):
    race_ids = []
    page = 1
    while True:
        url = f"https://db.netkeiba.com/?pid=race_list&word=&start_year={year}&start_mon={month}&end_year={year}&end_mon={month}&sort=date&list=100&page={page}"
        soup = get_html(url)
        if not soup: break
        table = soup.find("table", class_="race_table_01")
        if not table: break
        rows = table.find_all("tr")
        if len(rows) <= 1: break
        current_ids = []
        for row in rows[1:]:
            a = row.find("a", href=re.compile(r"/race/\d+"))
            if a:
                match = re.search(r"/race/(\d+)", a["href"])
                if match: current_ids.append(match.group(1))
        if not current_ids: break
        race_ids.extend(current_ids)
        page += 1
        time.sleep(1)
    return race_ids

def get_race_details(race_id):
    url = f"https://db.netkeiba.com/race/{race_id}/"
    soup = get_html(url)
    if not soup: return []
    intro = soup.find("div", class_="data_intro")
    date_str, place, track, dist, cond = "", "ãã®ä»–", "èŠ", 1600, "è‰¯"
    if intro:
        txt = intro.get_text()
        d_m = re.search(r"(\d+å¹´\d+æœˆ\d+æ—¥)", txt)
        if d_m: date_str = d_m.group(1)
        if "ãƒ€" in txt: track = "ãƒ€ãƒ¼ãƒˆ"
        elif "éšœ" in txt: track = "éšœå®³"
        dist_m = re.search(r"(\d+)m", txt)
        if dist_m: dist = int(dist_m.group(1))
        p_code = race_id[4:6]
        places = {"05":"æ±äº¬","06":"ä¸­å±±","08":"äº¬éƒ½","09":"é˜ªç¥"}
        place = places.get(p_code, "ãã®ä»–")
        if "ç¨" in txt: cond = "ç¨é‡"
        elif "é‡" in txt: cond = "é‡"
        elif "ä¸" in txt: cond = "ä¸è‰¯"
    table = soup.find("table", class_="race_table_01")
    if not table: return []
    rows = table.find_all("tr")
    headers = [th.get_text().strip() for th in rows[0].find_all("th")]
    try:
        i_rank = headers.index("ç€é †")
        i_name = headers.index("é¦¬å")
        i_time = headers.index("ã‚¿ã‚¤ãƒ ")
        i_w = headers.index("æ–¤é‡")
    except: return []
    records = []
    for row in rows[1:]:
        cols = row.find_all("td")
        if len(cols) != len(headers): continue
        try:
            r_str = cols[i_rank].get_text().strip()
            if not r_str.isdigit(): continue
            rank = int(r_str)
            name = cols[i_name].get_text().strip()
            t_str = cols[i_time].get_text().strip()
            sec = 0.0
            if ":" in t_str:
                p = t_str.split(":")
                sec = float(p[0])*60 + float(p[1])
            w = float(cols[i_w].get_text().strip())
            records.append({
                "race_id": race_id, "date": date_str, "place": place, "track": track,
                "distance": dist, "condition": cond, "rank": rank, "horse_name": name,
                "time_str": t_str, "seconds": round(sec, 1), "weight": w, "age_sex": "",
                "is_abnormal_type": False, "is_statistical_outlier": False, "is_outlier": False
            })
        except: continue
    return records

print(f"ã‚¹ã‚­ãƒƒãƒ—ãƒªã‚¹ãƒˆ({SKIP_FILENAME})ã‚’èª­ã¿è¾¼ã¿ä¸­...")
skipped_ids = set()
if os.path.exists(SKIP_FILENAME):
    with open(SKIP_FILENAME, "r", encoding="utf-8") as f:
        for line in f:
            clean_line = line.strip()
            if "]" in clean_line: clean_line = clean_line.split("]")[1].strip()
            if clean_line.isdigit(): skipped_ids.add(clean_line)
    print(f"-> {len(skipped_ids)}ä»¶ã®IDã‚’ç„¡è¦–è¨­å®šã—ã¾ã—ãŸã€‚")
else:
    print(f"-> ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚å…¨ä»¶å–å¾—ã—ã¾ã™ã€‚")

print(f"{TARGET_YEAR}å¹´{TARGET_MONTH}æœˆã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ä¸­...")
r_ids = get_race_ids(TARGET_YEAR, TARGET_MONTH)
target_ids = [rid for rid in r_ids if rid not in skipped_ids]
print(f"å¯¾è±¡ãƒ¬ãƒ¼ã‚¹æ•°: {len(target_ids)}ä»¶")

all_data = []
for i, rid in enumerate(target_ids):
    data = get_race_details(rid)
    if data: all_data.extend(data)
    time.sleep(1)
    if i % 10 == 0: print(f"{i}/{len(target_ids)}")
if all_data:
    df = pd.DataFrame(all_data)
    filename = f"new_data_{TARGET_YEAR}_{TARGET_MONTH}.csv"
    df.to_csv(filename, index=False, encoding="utf-8-sig")
    print("å®Œäº†ï¼ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™...")
    files.download(filename)
else:
    print("ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ")
`;

    window.onload = function() {
        // â˜…ãƒãƒ¼ã‚¸ãƒ§ãƒ³è¡¨ç¤º
        document.getElementById('appVersion').innerText = "(" + APP_VERSION + ")";
        
        openDB(); // èµ·å‹•æ™‚ã«DBã‚’é–‹ã
        document.getElementById('pythonCode').value = pythonScriptContent;
    };

    function copyScript() {
        const copyText = document.getElementById("pythonCode");
        copyText.select();
        navigator.clipboard.writeText(copyText.value).then(() => {
            alert("ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼Colabã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚");
        });
    }

    // --- IndexedDBå‡¦ç† (ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°å¼·åŒ–ç‰ˆ) ---
    function openDB() {
        const request = indexedDB.open(DB_NAME, DB_VERSION);
        request.onupgradeneeded = function(event) {
            db = event.target.result;
            if (!db.objectStoreNames.contains(STORE_NAME)) {
                db.createObjectStore(STORE_NAME, { keyPath: 'id' });
            }
        };
        request.onsuccess = function(event) {
            db = event.target.result;
            loadFromDB(); // DBãŒé–‹ã‘ãŸã‚‰ãƒ­ãƒ¼ãƒ‰è©¦è¡Œ
        };
        request.onerror = function(event) { console.error("Database error"); };
    }

    function saveToDB(csvText, fileName, callback) {
        if (!db) {
            alert("ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãŒæº–å‚™ã§ãã¦ã„ã¾ã›ã‚“ã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚");
            resetUI();
            return;
        }

        try {
            const transaction = db.transaction([STORE_NAME], 'readwrite');
            const store = transaction.objectStore(STORE_NAME);
            const data = { id: 'mainCSV', content: csvText, fileName: fileName, date: new Date().toLocaleString() };
            
            const request = store.put(data);
            
            request.onsuccess = function() {
                document.getElementById('fileStatus').innerHTML = `<span class="status-success">ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°ãƒ»ä¿å­˜ã—ã¾ã—ãŸ (${data.date})</span>`;
                if (callback) callback();
            };
            
            transaction.onerror = function(event) {
                 console.error("Transaction error:", event);
                 alert("ä¿å­˜å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: " + (event.target.error ? event.target.error.message : "ä¸æ˜ãªã‚¨ãƒ©ãƒ¼"));
                 resetUI();
            };
             
            request.onerror = function(event) {
                console.error("Request error:", event);
                alert("ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚å®¹é‡ä¸è¶³ãªã©ã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚");
                resetUI();
            };

        } catch (e) {
            console.error(e);
            alert("ä¿å­˜å‡¦ç†é–‹å§‹æ™‚ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: " + e.message);
            resetUI();
        }
    }

    function loadFromDB() {
        const transaction = db.transaction([STORE_NAME], 'readonly');
        const store = transaction.objectStore(STORE_NAME);
        store.get('mainCSV').onsuccess = function(event) {
            const result = event.target.result;
            if (result) {
                document.getElementById('fileStatus').innerHTML = `<span class="status-loading">å‰å›ä¿å­˜ãƒ‡ãƒ¼ã‚¿ (${result.date}) ã‚’å±•é–‹ä¸­...</span>`;
                setTimeout(() => {
                    parseCSV(result.content, false); 
                    document.getElementById('fileStatus').innerHTML = `<span class="status-success">å‰å›ãƒ‡ãƒ¼ã‚¿ (${result.date}) ã‚’å¾©å…ƒã—ã¾ã—ãŸ</span>`;
                    document.getElementById('clearDataArea').classList.remove('hidden');
                }, 100);
            } else {
                document.getElementById('fileStatus').innerText = "ãƒ‡ãƒ¼ã‚¿æœªãƒ­ãƒ¼ãƒ‰ (CSVã‚’é¸æŠã—ã¦ãã ã•ã„)";
            }
        };
    }

    function clearDB() {
        if(!confirm("ä¿å­˜ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
        const transaction = db.transaction([STORE_NAME], 'readwrite');
        transaction.objectStore(STORE_NAME).delete('mainCSV');
        location.reload();
    }

    // --- CSV & æœŸé–“ãƒ•ã‚£ãƒ«ã‚¿å‡¦ç† ---
    function switchTab(tabName) {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.content').forEach(c => c.classList.remove('active'));
        
        const tabs = document.querySelectorAll('.tab');
        if(tabName === 'ranking') tabs[0].classList.add('active');
        else if(tabName === 'search') tabs[1].classList.add('active');
        else tabs[2].classList.add('active');

        document.getElementById(tabName).classList.add('active');
    }

    document.getElementById('csvFile').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(event) { parseCSV(event.target.result, true, file.name); };
        reader.readAsText(file);
    });

    function parseCSV(text, shouldSave = false, fileName = "") {
        if (text.charCodeAt(0) === 0xFEFF) text = text.slice(1);
        const lines = text.split(/\r\n|\n/);
        const headerLine = lines[0];
        csvHeaders = headerLine.split(',').map(h => h.trim().replace(/"/g, ''));
        const data = [];
        const rawData = [];
        let minYear = 9999;
        let maxYear = 0;

        for (let i = 1; i < lines.length; i++) {
            if (!lines[i].trim()) continue;
            const cols = lines[i].split(',');
            if (cols.length < csvHeaders.length) continue;
            const record = {};
            csvHeaders.forEach((h, idx) => { record[h] = cols[idx] ? cols[idx].trim() : ''; });
            record.distance = parseInt(record.distance) || 0;
            record.seconds = parseFloat(record.seconds) || 0.0;
            record.is_outlier = (record.is_outlier === 'True' || record.is_outlier === 'true');
            
            const dateMatch = record.date.match(/(\d+)å¹´(\d+)æœˆ/);
            if (dateMatch) {
                record.year = parseInt(dateMatch[1]);
                record.month = parseInt(dateMatch[2]);
                if(record.year < minYear) minYear = record.year;
                if(record.year > maxYear) maxYear = record.year;
            } else {
                record.year = 0; record.month = 0;
            }

            data.push(record);
            rawData.push(record);
        }
        allRecords = data;
        rawRecords = rawData;
        
        setupDateFilter(minYear, maxYear);
        applyDateFilter(true); 

        if (shouldSave) {
            saveToDB(text, fileName, function() {
                console.log("åˆæœŸãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜å®Œäº†");
            });
        }
    }
    
    function setupDateFilter(minYear, maxYear) {
        if (allRecords.length === 0) return;
        const yearSelect = document.getElementById('startYear');
        yearSelect.innerHTML = '';
        for (let y = minYear; y <= maxYear; y++) {
            const opt = document.createElement('option');
            opt.value = y;
            opt.innerText = y;
            yearSelect.appendChild(opt);
        }
        yearSelect.value = minYear;
        document.getElementById('startMonth').value = 1;
        document.getElementById('periodFilterArea').classList.add('visible');
    }

    function applyDateFilter(refreshUI = true) {
        const sYear = parseInt(document.getElementById('startYear').value);
        const sMonth = parseInt(document.getElementById('startMonth').value);
        const startVal = sYear * 100 + sMonth;
        
        activeRecords = allRecords.filter(r => {
            const rVal = r.year * 100 + r.month;
            return rVal >= startVal;
        });
        
        document.getElementById('periodCount').innerText = `å¯¾è±¡ãƒ‡ãƒ¼ã‚¿: ${activeRecords.length} / ${allRecords.length}ä»¶`;
        
        if (refreshUI) {
            updateRanking();
            if(!isComparisonMode) searchHorse();
            else updateComparison();
        }
    }

    // --- ãƒãƒ¼ã‚¸å‡¦ç† ---
    document.getElementById('updateFile').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file || allRecords.length === 0) { alert("å…ˆã«ãƒ¡ã‚¤ãƒ³CSVã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„ã€‚"); return; }
        const reader = new FileReader();
        reader.onload = function(event) { mergeCSVProcess(event.target.result); };
        reader.readAsText(file);
    });

    function mergeCSVProcess(newCsvText) {
        if (newCsvText.charCodeAt(0) === 0xFEFF) newCsvText = newCsvText.slice(1);
        const lines = newCsvText.split(/\r\n|\n/);
        let addedCount = 0;
        let updatedCount = 0;
        const recordMap = new Map();
        rawRecords.forEach(r => {
            const key = r.race_id + "_" + r.horse_name;
            recordMap.set(key, r);
        });
        const newHeaders = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
        for (let i = 1; i < lines.length; i++) {
            if (!lines[i].trim()) continue;
            const cols = lines[i].split(',');
            const newRecord = {};
            newHeaders.forEach((h, idx) => { newRecord[h] = cols[idx] ? cols[idx].trim() : ''; });
            const key = newRecord.race_id + "_" + newRecord.horse_name;
            if (recordMap.has(key)) updatedCount++; else addedCount++;
            recordMap.set(key, newRecord);
        }
        const headerStr = csvHeaders.join(",");
        let bodyStr = "";
        const mergedList = Array.from(recordMap.values());
        mergedList.sort((a, b) => (a.date < b.date ? 1 : -1)); 
        mergedList.forEach(r => {
            const row = csvHeaders.map(h => r[h] !== undefined ? r[h] : "").join(",");
            bodyStr += row + "\n";
        });
        mergedContent = headerStr + "\n" + bodyStr;
        document.getElementById('updateResult').innerHTML = `è¿½è¨˜æº–å‚™OKï¼<br>è¿½åŠ : ${addedCount}ä»¶ / æ›´æ–°: ${updatedCount}ä»¶<br>åˆè¨ˆ: ${mergedList.length}ä»¶`;
        document.getElementById('mergeActionArea').classList.remove('hidden');
    }

    // UIãƒªã‚»ãƒƒãƒˆç”¨é–¢æ•°
    function resetUI() {
        const btn = document.getElementById('saveInternalBtn');
        btn.disabled = false;
        btn.innerHTML = `ğŸ’¾ è¿½è¨˜ã—ã¦ã‚¢ãƒ—ãƒªå†…ã«ä¿å­˜<br><span style="font-size:0.8rem; font-weight:normal;">(æ¬¡å›ã‹ã‚‰ã“ã®ãƒ‡ãƒ¼ã‚¿ãŒé–‹ãã¾ã™)</span>`;
    }

    function saveMergedToDB() {
        if(!mergedContent) return;
        
        const btn = document.getElementById('saveInternalBtn');
        btn.disabled = true;
        btn.innerHTML = "â³ ä¿å­˜å‡¦ç†ä¸­...";
        
        // ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ä»˜ãã§ä¿å­˜ã‚’å®Ÿè¡Œ
        saveToDB(mergedContent, "merged_data.csv", function() {
            parseCSV(mergedContent, false); 
            
            resetUI();
            document.getElementById('updateFile').value = "";
            document.getElementById('updateResult').innerHTML = "";
            document.getElementById('mergeActionArea').classList.add('hidden');

            setTimeout(() => {
                alert("âœ… ä¿å­˜ãŒå®Œäº†ã—ã¾ã—ãŸï¼\n\næœ€æ–°ãƒ‡ãƒ¼ã‚¿ã§ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚");
                switchTab('ranking');
            }, 100);
        });
    }

    function downloadMergedCSV() {
        const blob = new Blob([new Uint8Array([0xEF, 0xBB, 0xBF]), mergedContent], { type: "text/csv" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "app_data_combined.csv";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    // --- ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒ»æ¤œç´¢ ---
    function updateRanking() {
        if (activeRecords.length === 0) {
            document.getElementById('rankingList').innerHTML = '<div style="padding:20px; text-align:center; color:#999;">å¯¾è±¡æœŸé–“å†…ã®ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>';
            return;
        }
        const place = document.getElementById('placeSelect').value;
        const track = document.getElementById('trackSelect').value;
        const dist = parseInt(document.getElementById('distSelect').value);
        const showOutlier = document.getElementById('outlierCheck').checked;
        const filtered = activeRecords.filter(r => {
            return (place === 'å…¨ã¦' || r.place === place) && (r.track === track) && (r.distance === dist) && (showOutlier ? true : !r.is_outlier);
        });
        filtered.sort((a, b) => a.seconds - b.seconds);
        renderList(filtered.slice(0, 100), 'rankingList', true);
    }

    function searchHorse() {
        isComparisonMode = false;
        document.getElementById('searchFilterArea').classList.add('hidden');
        document.getElementById('searchResultTitle').innerText = "æ¤œç´¢çµæœ (æŒ‡å®šæœŸé–“å†…)";
        document.getElementById('searchResultTitle').style.display = "block";
        const query = document.getElementById('searchInput').value;
        if (!query) { document.getElementById('searchList').innerHTML = ''; return; }
        const hits = [...new Set(activeRecords.map(r => r.horse_name))].filter(name => name.includes(query)).sort();
        const container = document.getElementById('searchList');
        container.innerHTML = '';
        hits.forEach(name => {
            const div = document.createElement('div');
            div.className = 'record-item'; div.style.cursor = 'pointer';
            const isSelected = selectedHorses.has(name);
            const icon = isSelected ? '<span class="check-icon">âœ”</span>' : '<button class="btn-add">ï¼‹</button>';
            div.innerHTML = `<span class="horse-name">${name}</span> ${icon}`;
            div.onclick = () => toggleSelectHorse(name);
            container.appendChild(div);
        });
    }

    function toggleSelectHorse(name) {
        if (selectedHorses.has(name)) selectedHorses.delete(name); else selectedHorses.add(name);
        updateSelectedArea();
        if (!isComparisonMode) searchHorse(); else updateComparison();
    }

    function updateSelectedArea() {
        const area = document.getElementById('selectedArea');
        const container = document.getElementById('selectedTags');
        if (selectedHorses.size === 0) { area.style.display = 'none'; return; }
        area.style.display = 'block'; container.innerHTML = '';
        selectedHorses.forEach(name => {
            const tag = document.createElement('div'); tag.className = 'horse-tag';
            tag.innerHTML = `${name} <span class="remove-btn" onclick="toggleSelectHorse('${name}')">Ã—</span>`;
            container.appendChild(tag);
        });
    }

    function showComparison() {
        isComparisonMode = true;
        document.getElementById('searchFilterArea').classList.remove('hidden');
        document.getElementById('searchResultTitle').innerText = "å±¥æ­´æ¯”è¼ƒ (æŒ‡å®šæœŸé–“å†…)";
        updateComparison();
    }

    function updateComparison() {
        if (!isComparisonMode) return;
        const place = document.getElementById('s_placeSelect').value;
        const track = document.getElementById('s_trackSelect').value;
        const distStr = document.getElementById('s_distSelect').value;
        const showOutlier = document.getElementById('s_outlierCheck').checked;
        let filtered = activeRecords.filter(r => selectedHorses.has(r.horse_name));
        filtered = filtered.filter(r => {
            return (place === 'å…¨ã¦' || r.place === place) && (track === 'å…¨ã¦' || r.track === track) && (distStr === 'å…¨ã¦' || r.distance === parseInt(distStr)) && (showOutlier ? true : !r.is_outlier);
        });
        filtered.sort((a, b) => a.seconds - b.seconds);
        renderList(filtered, 'searchList', false, true);
    }

    function renderList(data, targetId, isRanking, highlightName = false) {
        const container = document.getElementById(targetId); container.innerHTML = '';
        if (data.length === 0) { container.innerHTML = '<div style="padding:15px; text-align:center; color:#999;">è©²å½“ãƒ‡ãƒ¼ã‚¿ãªã—</div>'; return; }
        data.forEach((r, index) => {
            const div = document.createElement('div'); div.className = 'record-item';
            let rankHtml = '';
            if (isRanking) {
                let rankClass = 'rank-other';
                if (index === 0) rankClass = 'rank-1'; if (index === 1) rankClass = 'rank-2'; if (index === 2) rankClass = 'rank-3';
                rankHtml = `<div class="rank-badge ${rankClass}">${index + 1}</div>`;
            }
            const timeColorClass = r.is_outlier ? 'outlier' : '';
            const refText = r.is_outlier ? '<div class="ref-text">å‚è€ƒ</div>' : '';
            const nameStyle = highlightName ? 'color:#007aff;' : '';
            div.innerHTML = `
                <div style="display:flex; align-items:center;">
                    ${rankHtml}
                    <div><span class="horse-name" style="${nameStyle}">${r.horse_name}</span>
                        <div class="meta-info">${r.date} (${r.place}) <span style="font-weight:bold;">${r.track}${r.distance}m</span></div>
                    </div>
                </div>
                <div style="text-align:right;">
                    <div class="time-str ${timeColorClass}">${r.time_str}</div>
                    <div class="condition">${r.condition} / ${r.rank}ç€</div>
                    ${refText}
                </div>`;
            container.appendChild(div);
        });
    }
</script>
</body>
</html>