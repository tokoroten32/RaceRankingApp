<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç«¶é¦¬ãƒ‡ãƒ¼ã‚¿åˆ†æ Web</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", sans-serif; margin: 0; padding: 0; background: #f2f2f7; color: #333; }
        header { background: #fff; padding: 15px; text-align: center; border-bottom: 1px solid #ccc; position: sticky; top: 0; z-index: 100; }
        h1 { margin: 0; font-size: 1.2rem; }
        .version-tag { font-size: 0.8rem; color: #888; font-weight: normal; margin-left: 5px; }
        .file-area { padding: 15px; background: #fff; margin-bottom: 10px; text-align: center; }
        .status-box { font-size: 0.8rem; color: #666; margin-top: 8px; min-height: 1.2em; }
        .status-success { color: #34c759; font-weight: bold; }
        .status-loading { color: #007aff; }
        .status-error { color: #ff3b30; font-weight: bold; }
        .period-area { margin-top: 15px; padding-top: 15px; border-top: 1px dashed #ccc; display: none; }
        .period-area.visible { display: block; }
        .period-control { display: flex; justify-content: center; align-items: center; gap: 5px; margin-top: 5px; }
        .period-select { padding: 5px; border: 1px solid #ddd; border-radius: 5px; font-size: 1rem; width: auto; }
        .tabs { display: flex; background: #fff; border-bottom: 1px solid #ccc; }
        .tab { flex: 1; padding: 15px; text-align: center; cursor: pointer; color: #888; border-bottom: 3px solid transparent; font-size: 0.9rem; }
        .tab.active { color: #007aff; border-bottom: 3px solid #007aff; font-weight: bold; }
        .content { display: none; padding: 15px; }
        .content.active { display: block; }
        .filter-group { background: #fff; padding: 15px; border-radius: 10px; margin-bottom: 15px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .filter-row { display: flex; gap: 10px; margin-bottom: 10px; }
        .filter-row:last-child { margin-bottom: 0; }
        select, input[type="text"] { flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 5px; font-size: 1rem; }
        .record-list { list-style: none; padding: 0; margin: 0; }
        .record-item { background: #fff; padding: 12px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .record-item:last-child { border-bottom: none; }
        .rank-badge { width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; margin-right: 10px; font-size: 0.9rem; flex-shrink: 0; }
        .rank-1 { background: gold; color: #fff; }
        .rank-2 { background: silver; color: #fff; }
        .rank-3 { background: #cd7f32; color: #fff; }
        .rank-other { background: #eee; color: #333; }
        .horse-name { font-weight: bold; font-size: 1.1rem; display: block; }
        .meta-info { font-size: 0.8rem; color: #666; }
        .time-str { font-weight: bold; font-size: 1.2rem; font-family: monospace; }
        .condition { font-size: 0.7rem; color: #999; }
        .outlier { color: red; }
        .ref-text { color: red; font-size: 0.7rem; }
        .search-box { display: flex; gap: 5px; }
        .selected-horses-area { background: #fff; padding: 10px; border-radius: 10px; margin-bottom: 15px; }
        .tag-container { display: flex; flex-wrap: wrap; gap: 5px; margin-bottom: 10px; }
        .horse-tag { background: #e0f0ff; color: #007aff; padding: 5px 10px; border-radius: 15px; font-size: 0.9rem; display: flex; align-items: center; gap: 5px; border: 1px solid #007aff; }
        .remove-btn { cursor: pointer; font-weight: bold; }
        .btn-compare { width: 100%; padding: 10px; background: #007aff; color: white; border: none; border-radius: 8px; font-size: 1rem; cursor: pointer; }
        .btn-add { background: none; border: none; color: #007aff; font-size: 1.5rem; cursor: pointer; }
        .check-icon { color: #007aff; font-size: 1.2rem; }
        .hidden { display: none !important; }
        .update-box { text-align: center; padding: 20px; border: 2px dashed #ccc; border-radius: 10px; background: #fafafa; margin-bottom: 20px; }
        .btn-primary { background: #007aff; color: white; border: none; padding: 10px 20px; border-radius: 8px; font-size: 1.1rem; cursor: pointer; font-weight: bold; width: 100%; margin-bottom: 10px; transition: background 0.3s; }
        .btn-primary:disabled { background: #ccc; cursor: not-allowed; }
        .btn-secondary { background: #8e8e93; color: white; border: none; padding: 10px 20px; border-radius: 8px; font-size: 0.9rem; cursor: pointer; }
        .btn-danger { background: #ff3b30; color: white; border: none; padding: 8px 15px; border-radius: 5px; font-size: 0.8rem; cursor: pointer; margin-top: 5px; }
        .script-area { text-align: left; margin-bottom: 20px; }
        .code-box { width: 100%; height: 100px; font-family: monospace; font-size: 0.8rem; border: 1px solid #ddd; border-radius: 5px; padding: 5px; background: #f0f0f0; color: #555; box-sizing: border-box; resize: vertical; }
        .btn-copy { background: #5856d6; color: white; border: none; padding: 8px 15px; border-radius: 5px; font-size: 0.9rem; cursor: pointer; margin-right: 5px; }
        .btn-colab { background: #f9ab00; color: white; border: none; padding: 8px 15px; border-radius: 5px; font-size: 0.9rem; cursor: pointer; text-decoration: none; display: inline-block; }
    </style>
</head>
<body>

<header>
    <h1>ç«¶é¦¬ãƒ‡ãƒ¼ã‚¿åˆ†æ Web <span id="appVersion" class="version-tag"></span></h1>
</header>

<div class="file-area">
    <label for="csvFile" style="font-weight:bold;">ãƒ¡ã‚¤ãƒ³ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿</label><br>
    <div style="font-size:0.7rem; color:#888; margin-bottom:5px;">(â€»é€šå¸¸ã¯è‡ªå‹•ã§èª­ã¿è¾¼ã¾ã‚Œã¾ã™)</div>
    <input type="file" id="csvFile" accept=".csv">
    <div id="fileStatus" class="status-box">ãƒ‡ãƒ¼ã‚¿æœªãƒ­ãƒ¼ãƒ‰</div>
    <div id="clearDataArea" class="hidden">
        <button class="btn-danger" onclick="clearDB()">ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¦ãƒªã‚»ãƒƒãƒˆ</button>
    </div>

    <div id="periodFilterArea" class="period-area">
        <div style="font-size:0.8rem; font-weight:bold; color:#007aff;">â–¼ å¯¾è±¡æœŸé–“ã®è¨­å®š</div>
        <div class="period-control">
            <select id="startYear" class="period-select" onchange="applyDateFilter()"></select>
            <span>å¹´</span>
            <select id="startMonth" class="period-select" onchange="applyDateFilter()">
                <option value="1">1</option><option value="2">2</option><option value="3">3</option>
                <option value="4">4</option><option value="5">5</option><option value="6">6</option>
                <option value="7">7</option><option value="8">8</option><option value="9">9</option>
                <option value="10">10</option><option value="11">11</option><option value="12">12</option>
            </select>
            <span>æœˆ ã€œ æœ€æ–°</span>
        </div>
        <div id="periodCount" style="font-size:0.7rem; color:#666; margin-top:5px;"></div>
    </div>
</div>

<div class="tabs">
    <div class="tab active" onclick="switchTab('ranking')">ãƒ©ãƒ³ã‚­ãƒ³ã‚°</div>
    <div class="tab" onclick="switchTab('search')">é¦¬æ¤œç´¢ãƒ»æ¯”è¼ƒ</div>
    <div class="tab" onclick="switchTab('update')">ãƒ‡ãƒ¼ã‚¿è¿½åŠ </div>
</div>

<div id="ranking" class="content active">
    <div class="filter-group">
        <div class="filter-row">
            <select id="placeSelect" onchange="updateRanking()">
                <option value="å…¨ã¦">å ´æ‰€: å…¨ã¦</option>
                <option value="æ±äº¬">æ±äº¬</option>
                <option value="ä¸­å±±">ä¸­å±±</option>
                <option value="äº¬éƒ½">äº¬éƒ½</option>
                <option value="é˜ªç¥">é˜ªç¥</option>
                <option value="ãã®ä»–">ãã®ä»–</option>
            </select>
            <select id="trackSelect" onchange="updateRanking()">
                <option value="èŠ" selected>èŠ</option>
                <option value="ãƒ€ãƒ¼ãƒˆ">ãƒ€ãƒ¼ãƒˆ</option>
                <option value="éšœå®³">éšœå®³</option>
            </select>
        </div>
        <div class="filter-row">
            <select id="distSelect" onchange="updateRanking()">
                <option value="1200">1200m</option>
                <option value="1400">1400m</option>
                <option value="1600" selected>1600m</option>
                <option value="1800">1800m</option>
                <option value="2000">2000m</option>
                <option value="2400">2400m</option>
            </select>
            <label style="display:flex; align-items:center; font-size:0.8rem;">
                <input type="checkbox" id="outlierCheck" onchange="updateRanking()" checked> å‚è€ƒè¨˜éŒ²è¾¼
            </label>
        </div>
    </div>
    <div id="rankingList" class="record-list">
        <div style="text-align:center; color:#999; padding:20px;">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„</div>
    </div>
</div>

<div id="search" class="content">
    <div class="filter-group">
        <div class="search-box">
            <input type="text" id="searchInput" placeholder="é¦¬åã‚’å…¥åŠ› (ä¾‹: ãƒ‰ã‚¦ãƒ‡ãƒ¥ãƒ¼ã‚¹)" oninput="searchHorse()">
        </div>
    </div>
    <div class="selected-horses-area" id="selectedArea" style="display:none;">
        <div style="font-size:0.8rem; color:gray; margin-bottom:5px;">é¸æŠä¸­ã®é¦¬</div>
        <div class="tag-container" id="selectedTags"></div>
        <button class="btn-compare" onclick="showComparison()">ã“ã®ãƒ¡ãƒ³ãƒãƒ¼ã®å±¥æ­´ã‚’æ¯”è¼ƒ</button>
    </div>
    <div id="searchFilterArea" class="filter-group hidden">
        <div style="font-size:0.8rem; color:#007aff; margin-bottom:8px; font-weight:bold;">â–¼ çµã‚Šè¾¼ã¿æ¡ä»¶</div>
        <div class="filter-row">
            <select id="s_placeSelect" onchange="updateComparison()">
                <option value="å…¨ã¦" selected>å ´æ‰€: å…¨ã¦</option>
                <option value="æ±äº¬">æ±äº¬</option>
                <option value="ä¸­å±±">ä¸­å±±</option>
                <option value="äº¬éƒ½">äº¬éƒ½</option>
                <option value="é˜ªç¥">é˜ªç¥</option>
                <option value="ãã®ä»–">ãã®ä»–</option>
            </select>
            <select id="s_trackSelect" onchange="updateComparison()">
                <option value="å…¨ã¦" selected>ãƒˆãƒ©ãƒƒã‚¯: å…¨ã¦</option>
                <option value="èŠ">èŠ</option>
                <option value="ãƒ€ãƒ¼ãƒˆ">ãƒ€ãƒ¼ãƒˆ</option>
                <option value="éšœå®³">éšœå®³</option>
            </select>
        </div>
        <div class="filter-row">
            <select id="s_distSelect" onchange="updateComparison()">
                <option value="å…¨ã¦" selected>è·é›¢: å…¨ã¦</option>
                <option value="1200">1200m</option>
                <option value="1400">1400m</option>
                <option value="1600">1600m</option>
                <option value="1800">1800m</option>
                <option value="2000">2000m</option>
                <option value="2400">2400m</option>
            </select>
            <label style="display:flex; align-items:center; font-size:0.8rem;">
                <input type="checkbox" id="s_outlierCheck" onchange="updateComparison()" checked> å‚è€ƒè¨˜éŒ²è¾¼
            </label>
        </div>
    </div>
    <div id="searchResultTitle" style="margin: 10px 0; font-weight:bold; display:none;">æ¤œç´¢çµæœ</div>
    <div id="searchList" class="record-list"></div>
</div>

<div id="update" class="content">
    <div class="filter-group">
        <h3 style="margin-top:0;">1. æ–°ãƒ‡ãƒ¼ã‚¿ã®å–å¾—</h3>
        <p style="font-size:0.9rem; color:#666;">
            Google Colabã§ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã—ã€CSV(ä¾‹: new_data.csv)ã‚’å–å¾—ã—ã¾ã™ã€‚
        </p>
        <div class="script-area">
            <textarea id="pythonCode" class="code-box" readonly></textarea>
            <div style="margin-top:5px; text-align:center;">
                <button class="btn-copy" onclick="copyScript()">ğŸ“‹ ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼</button>
                <a href="https://colab.research.google.com/" target="_blank" class="btn-colab">ğŸš€ Colabã‚’é–‹ã</a>
            </div>
        </div>
    </div>
    <div class="filter-group">
        <h3 style="margin-top:0;">2. æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã«è¿½è¨˜</h3>
        <p style="font-size:0.9rem; color:#666;">
            æ–°ã—ãå–å¾—ã—ãŸCSVã‚’é¸æŠã—ã€ã€Œã‚¢ãƒ—ãƒªå†…ã«ä¿å­˜ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚<br>
            <span style="color:#007aff; font-weight:bold;">ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ä¸è¦ã§ã€ãã®ã¾ã¾ä½¿ãˆã¾ã™ã€‚</span>
        </p>
        <div class="update-box">
            <label style="display:block; margin-bottom:10px; font-weight:bold;">è¿½åŠ ã™ã‚‹CSV (new_data.csv)</label>
            <input type="file" id="updateFile" accept=".csv">
        </div>
        <div id="updateResult" style="margin-bottom:20px; font-weight:bold; color:#007aff;"></div>
        <div id="mergeActionArea" class="hidden">
            <button id="saveInternalBtn" class="btn-primary" onclick="saveMergedToDB()">
                ğŸ’¾ è¿½è¨˜ã—ã¦ã‚¢ãƒ—ãƒªå†…ã«ä¿å­˜<br>
                <span style="font-size:0.8rem; font-weight:normal;">(æ¬¡å›ã‹ã‚‰ã“ã®ãƒ‡ãƒ¼ã‚¿ãŒé–‹ãã¾ã™)</span>
            </button>
            <div style="margin-top:15px; border-top:1px solid #eee; padding-top:15px;">
                <p style="font-size:0.8rem; color:#666;">ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãŒå¿…è¦ãªå ´åˆã®ã¿:</p>
                <button id="downloadBtn" class="btn-secondary" onclick="downloadMergedCSV()">
                    CSVãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦æ›¸ãå‡ºã—
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    const APP_VERSION = "v1.4 (Worker Mode)";

    let allRecords = [];      
    let activeRecords = [];   
    let selectedHorses = new Set(); 
    let isComparisonMode = false;
    let mergedContent = ""; 
    // â€»ãƒ¡ãƒ¢ãƒªç¯€ç´„ã®ãŸã‚ rawRecords ã‚„ csvHeaders ã¯ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«æŒãŸãªã„ã‚ˆã†ã«å¤‰æ›´

    const DB_NAME = 'KeibaAppDB';
    const DB_VERSION = 2;
    const STORE_NAME = 'csvStore';
    let db;

    const pythonScriptContent = `# Google Colabç”¨ ç«¶é¦¬ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
import requests
from bs4 import BeautifulSoup
import pandas as pd
import time
import re
import random
import os
from google.colab import files

TARGET_YEAR = 2025
TARGET_MONTH = 1
SKIP_FILENAME = "skipped_ids.txt"

USER_AGENTS = [
    "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/115.0.0.0 Safari/537.36",
    "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/115.0.0.0 Safari/537.36"
]

def get_html(url):
    try:
        headers = {"User-Agent": random.choice(USER_AGENTS)}
        res = requests.get(url, headers=headers, timeout=30)
        res.encoding = "euc-jp"
        return BeautifulSoup(res.text, "html.parser")
    except: return None

def get_race_ids(year, month):
    race_ids = []
    page = 1
    while True:
        url = f"https://db.netkeiba.com/?pid=race_list&word=&start_year={year}&start_mon={month}&end_year={year}&end_mon={month}&sort=date&list=100&page={page}"
        soup = get_html(url)
        if not soup: break
        table = soup.find("table", class_="race_table_01")
        if not table: break
        rows = table.find_all("tr")
        if len(rows) <= 1: break
        current_ids = []
        for row in rows[1:]:
            a = row.find("a", href=re.compile(r"/race/\d+"))
            if a:
                match = re.search(r"/race/(\d+)", a["href"])
                if match: current_ids.append(match.group(1))
        if not current_ids: break
        race_ids.extend(current_ids)
        page += 1
        time.sleep(1)
    return race_ids

def get_race_details(race_id):
    url = f"https://db.netkeiba.com/race/{race_id}/"
    soup = get_html(url)
    if not soup: return []
    intro = soup.find("div", class_="data_intro")
    date_str, place, track, dist, cond = "", "ãã®ä»–", "èŠ", 1600, "è‰¯"
    if intro:
        txt = intro.get_text()
        d_m = re.search(r"(\d+å¹´\d+æœˆ\d+æ—¥)", txt)
        if d_m: date_str = d_m.group(1)
        if "ãƒ€" in txt: track = "ãƒ€ãƒ¼ãƒˆ"
        elif "éšœ" in txt: track = "éšœå®³"
        dist_m = re.search(r"(\d+)m", txt)
        if dist_m: dist = int(dist_m.group(1))
        p_code = race_id[4:6]
        places = {"05":"æ±äº¬","06":"ä¸­å±±","08":"äº¬éƒ½","09":"é˜ªç¥"}
        place = places.get(p_code, "ãã®ä»–")
        if "ç¨" in txt: cond = "ç¨é‡"
        elif "é‡" in txt: cond = "é‡"
        elif "ä¸" in txt: cond = "ä¸è‰¯"
    table = soup.find("table", class_="race_table_01")
    if not table: return []
    rows = table.find_all("tr")
    headers = [th.get_text().strip() for th in rows[0].find_all("th")]
    try:
        i_rank = headers.index("ç€é †")
        i_name = headers.index("é¦¬å")
        i_time = headers.index("ã‚¿ã‚¤ãƒ ")
        i_w = headers.index("æ–¤é‡")
    except: return []
    records = []
    for row in rows[1:]:
        cols = row.find_all("td")
        if len(cols) != len(headers): continue
        try:
            r_str = cols[i_rank].get_text().strip()
            if not r_str.isdigit(): continue
            rank = int(r_str)
            name = cols[i_name].get_text().strip()
            t_str = cols[i_time].get_text().strip()
            sec = 0.0
            if ":" in t_str:
                p = t_str.split(":")
                sec = float(p[0])*60 + float(p[1])
            w = float(cols[i_w].get_text().strip())
            records.append({
                "race_id": race_id, "date": date_str, "place": place, "track": track,
                "distance": dist, "condition": cond, "rank": rank, "horse_name": name,
                "time_str": t_str, "seconds": round(sec, 1), "weight": w, "age_sex": "",
                "is_abnormal_type": False, "is_statistical_outlier": False, "is_outlier": False
            })
        except: continue
    return records

print(f"ã‚¹ã‚­ãƒƒãƒ—ãƒªã‚¹ãƒˆ({SKIP_FILENAME})ã‚’èª­ã¿è¾¼ã¿ä¸­...")
skipped_ids = set()
if os.path.exists(SKIP_FILENAME):
    with open(SKIP_FILENAME, "r", encoding="utf-8") as f:
        for line in f:
            clean_line = line.strip()
            if "]" in clean_line: clean_line = clean_line.split("]")[1].strip()
            if clean_line.isdigit(): skipped_ids.add(clean_line)
    print(f"-> {len(skipped_ids)}ä»¶ã®IDã‚’ç„¡è¦–è¨­å®šã—ã¾ã—ãŸã€‚")
else:
    print(f"-> ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚å…¨ä»¶å–å¾—ã—ã¾ã™ã€‚")

print(f"{TARGET_YEAR}å¹´{TARGET_MONTH}æœˆã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ä¸­...")
r_ids = get_race_ids(TARGET_YEAR, TARGET_MONTH)
target_ids = [rid for rid in r_ids if rid not in skipped_ids]
print(f"å¯¾è±¡ãƒ¬ãƒ¼ã‚¹æ•°: {len(target_ids)}ä»¶")

all_data = []
for i, rid in enumerate(target_ids):
    data = get_race_details(rid)
    if data: all_data.extend(data)
    time.sleep(1)
    if i % 10 == 0: print(f"{i}/{len(target_ids)}")
if all_data:
    df = pd.DataFrame(all_data)
    filename = f"new_data_{TARGET_YEAR}_{TARGET_MONTH}.csv"
    df.to_csv(filename, index=False, encoding="utf-8-sig")
    print("å®Œäº†ï¼ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™...")
    files.download(filename)
else:
    print("ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ")
`;

    window.onload = function() {
        document.getElementById('appVersion').innerText = "(" + APP_VERSION + ")";
        openDB(); 
        document.getElementById('pythonCode').value = pythonScriptContent;
    };

    function copyScript() {
        const copyText = document.getElementById("pythonCode");
        copyText.select();
        navigator.clipboard.writeText(copyText.value).then(() => {
            alert("ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼Colabã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚");
        });
    }

    // --- IndexedDBå‡¦ç† ---
    function openDB() {
        const request = indexedDB.open(DB_NAME, DB_VERSION);
        request.onupgradeneeded = function(event) {
            db = event.target.result;
            if (db.objectStoreNames.contains(STORE_NAME)) {
                db.deleteObjectStore(STORE_NAME);
            }
            db.createObjectStore(STORE_NAME, { keyPath: 'id' });
        };
        request.onsuccess = function(event) {
            db = event.target.result;
            loadFromDB(); 
        };
        request.onerror = function(event) { console.error("Database error"); };
    }

    // DBã¸ã®ä¿å­˜ (ãƒ¡ãƒ¢ãƒªç¯€ç´„ã®ãŸã‚Blobã‚’ä½¿ç”¨)
    function saveToDB(csvText, fileName, callback) {
        if (!db) { alert("DBæœªæ¥ç¶š"); resetUI(); return; }
        try {
            const transaction = db.transaction([STORE_NAME], 'readwrite');
            const store = transaction.objectStore(STORE_NAME);
            // æ–‡å­—åˆ—ã‚’ãã®ã¾ã¾å…¥ã‚Œã‚‹ã¨é‡ã„ã®ã§ã€ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã¯ç¶­æŒã—ã¤ã¤
            // æ–‡å­—åˆ—æ“ä½œã‚’æœ€å°é™ã«ã™ã‚‹
            const data = { id: 'mainCSV', content: csvText, fileName: fileName, date: new Date().toLocaleString() };
            const request = store.put(data);
            request.onsuccess = function() {
                document.getElementById('fileStatus').innerHTML = `<span class="status-success">ä¿å­˜å®Œäº† (${data.date})</span>`;
                if (callback) callback();
            };
            transaction.onerror = function(e) { console.error(e); alert("ä¿å­˜å¤±æ•—: " + e.target.error.message); resetUI(); };
        } catch (e) {
            console.error(e); alert("ä¿å­˜ã‚¨ãƒ©ãƒ¼: " + e.message); resetUI();
        }
    }

    function loadFromDB() {
        const transaction = db.transaction([STORE_NAME], 'readonly');
        const store = transaction.objectStore(STORE_NAME);
        store.get('mainCSV').onsuccess = function(event) {
            const result = event.target.result;
            if (result) {
                document.getElementById('fileStatus').innerHTML = `<span class="status-loading">ä¿å­˜ãƒ‡ãƒ¼ã‚¿å±•é–‹ä¸­...</span>`;
                // ãƒ¡ã‚¤ãƒ³ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’ãƒ–ãƒ­ãƒƒã‚¯ã—ãªã„ã‚ˆã†ã«setTimeoutã§é€ƒãŒã™
                setTimeout(() => {
                    parseCSV(result.content, false); 
                    document.getElementById('fileStatus').innerHTML = `<span class="status-success">å¾©å…ƒå®Œäº† (${result.date})</span>`;
                    document.getElementById('clearDataArea').classList.remove('hidden');
                }, 100);
            } else {
                document.getElementById('fileStatus').innerText = "ãƒ‡ãƒ¼ã‚¿æœªãƒ­ãƒ¼ãƒ‰";
            }
        };
    }

    function clearDB() {
        if(!confirm("ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
        const transaction = db.transaction([STORE_NAME], 'readwrite');
        transaction.objectStore(STORE_NAME).delete('mainCSV');
        location.reload();
    }

    // --- CSVå‡¦ç† ---
    document.getElementById('csvFile').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;
        // Fileã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¯ãã®ã¾ã¾PapaParseã«æ¸¡ã›ã‚‹
        parseFile(file, true);
    });

    // æ–‡å­—åˆ—ã§ã¯ãªãFileã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ç›´æ¥ãƒ‘ãƒ¼ã‚¹ã™ã‚‹ã“ã¨ã§ãƒ¡ãƒ¢ãƒªç¯€ç´„
    function parseFile(file, shouldSave) {
        document.getElementById('fileStatus').innerHTML = '<span class="status-loading">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è§£æä¸­(Worker)...</span>';
        
        Papa.parse(file, {
            header: true,
            skipEmptyLines: true,
            worker: true, // â˜…Workerã‚¹ãƒ¬ãƒƒãƒ‰ã§å®Ÿè¡Œ(UIãƒ•ãƒªãƒ¼ã‚ºå›é¿)
            complete: function(results) {
                // ã“ã“ã§å…¨ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ¡ãƒ¢ãƒªã«å±•é–‹ã—ã¦ã—ã¾ã†ãŒã€Workerã‹ã‚‰æˆ»ã£ã¦ããŸãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ã†
                processParsedData(results.data);
                
                if (shouldSave) {
                    // ä¿å­˜ã®ãŸã‚ã«ãƒ†ã‚­ã‚¹ãƒˆèª­ã¿è¾¼ã¿ãŒå¿…è¦ï¼ˆã“ã“ã ã‘ã¯é‡ããªã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ï¼‰
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        saveToDB(e.target.result, file.name);
                    };
                    reader.readAsText(file);
                } else {
                     document.getElementById('fileStatus').innerHTML = `<span class="status-success">ãƒ­ãƒ¼ãƒ‰å®Œäº† (${results.data.length}ä»¶)</span>`;
                }
            },
            error: function(err) {
                console.error(err);
                alert("è§£æã‚¨ãƒ©ãƒ¼: " + err.message);
                document.getElementById('fileStatus').innerText = "è§£æå¤±æ•—";
            }
        });
    }

    // æ–‡å­—åˆ—ã‹ã‚‰ã®ãƒ‘ãƒ¼ã‚¹ (DBå¾©å…ƒç”¨)
    function parseCSV(text, shouldSave, fileName) {
        document.getElementById('fileStatus').innerHTML = '<span class="status-loading">ãƒ‡ãƒ¼ã‚¿ã‚’è§£æä¸­(Worker)...</span>';
        Papa.parse(text, {
            header: true,
            skipEmptyLines: true,
            worker: true,
            complete: function(results) {
                processParsedData(results.data);
                if (shouldSave) {
                    saveToDB(text, fileName);
                }
            },
            error: function(err) {
                alert("è§£æã‚¨ãƒ©ãƒ¼");
            }
        });
    }

    function processParsedData(dataArray) {
        const data = [];
        let minYear = 9999;
        let maxYear = 0;

        // ãƒ¡ãƒ¢ãƒªç¯€ç´„ã®ãŸã‚ã€æœ€ä½é™ã®å¤‰æ›å‡¦ç†ã«ã¨ã©ã‚ã‚‹
        for (let i = 0; i < dataArray.length; i++) {
            const r = dataArray[i];
            if(!r.race_id) continue;
            
            // å‹å¤‰æ›
            r.distance = parseInt(r.distance) || 0;
            r.seconds = parseFloat(r.seconds) || 0.0;
            r.is_outlier = (r.is_outlier === 'True' || r.is_outlier === 'true');

            // å¹´æœˆ
            if (r.date) {
                const y = parseInt(r.date.substring(0, 4)); // é«˜é€ŸåŒ–: æ­£è¦è¡¨ç¾ã‚’ã‚„ã‚ã¦æ–‡å­—åˆ‡ã‚Šå‡ºã—
                const mIndex = r.date.indexOf("å¹´");
                if (!isNaN(y)) {
                    r.year = y;
                    // æœˆã¯ç°¡æ˜“çš„ã«æŠ½å‡º (ä¾‹: 2024å¹´1æœˆ -> 1)
                    if (mIndex !== -1) {
                         r.month = parseInt(r.date.substring(mIndex+1));
                    } else { r.month = 1; }

                    if(y < minYear) minYear = y;
                    if(y > maxYear) maxYear = y;
                } else { r.year = 0; r.month = 0; }
            }
            data.push(r);
        }

        allRecords = data;
        setupDateFilter(minYear, maxYear);
        applyDateFilter(true);
    }

    // --- ãƒãƒ¼ã‚¸å‡¦ç† ---
    document.getElementById('updateFile').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file || allRecords.length === 0) { alert("å…ˆã«ãƒ¡ã‚¤ãƒ³CSVã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„ã€‚"); return; }
        
        // ãƒ¡ãƒ¢ãƒªä¸è¶³å¯¾ç­–: ãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦èª­ã¿è¾¼ã‚“ã§Workerã§å‡¦ç†
        Papa.parse(file, {
            header: true,
            skipEmptyLines: true,
            worker: true,
            complete: function(results) {
                 // ãƒ†ã‚­ã‚¹ãƒˆèª­ã¿è¾¼ã¿ï¼ˆä¿å­˜ç”¨ï¼‰
                 const reader = new FileReader();
                 reader.onload = function(evt) {
                     performMerge(results.data, evt.target.result);
                 };
                 reader.readAsText(file);
            }
        });
    });

    function performMerge(newRecordsArray, newCsvText) {
        // é‡è¤‡æ’é™¤ãƒ­ã‚¸ãƒƒã‚¯
        // ãƒ¡ãƒ¢ãƒªç¯€ç´„ã®ãŸã‚ã€æ—¢å­˜allRecordsã¨æ–°ãƒ‡ãƒ¼ã‚¿ã‚’çµåˆã—ã¦ã€IDã§ãƒ¦ãƒ‹ãƒ¼ã‚¯åŒ–ã™ã‚‹
        // rawRecordsã‚’æŒãŸãšã«å‡¦ç†ã™ã‚‹
        
        let updatedCount = 0;
        let addedCount = 0;
        
        const existingMap = new Map();
        allRecords.forEach(r => {
             existingMap.set(r.race_id + "_" + r.horse_name, r);
        });
        
        const initialSize = existingMap.size;

        newRecordsArray.forEach(r => {
            if(!r.race_id) return;
            const key = r.race_id + "_" + r.horse_name;
            existingMap.set(key, r);
        });
        
        const finalSize = existingMap.size;
        addedCount = finalSize - initialSize;
        // æ›´æ–°æ•°ã¯æ¦‚ç®—ï¼ˆæ­£ç¢ºã«å‡ºã™ã«ã¯ã‚³ã‚¹ãƒˆãŒã‹ã‹ã‚‹ãŸã‚çœç•¥ï¼‰
        
        const mergedList = Array.from(existingMap.values());
        // æ—¥ä»˜ã‚½ãƒ¼ãƒˆ
        mergedList.sort((a, b) => (a.date < b.date ? 1 : -1));
        
        // CSVæ–‡å­—åˆ—ç”Ÿæˆ (ã“ã“ãŒä¸€ç•ªé‡ã„)
        try {
            mergedContent = Papa.unparse(mergedList);
            document.getElementById('updateResult').innerHTML = `è¿½è¨˜æº–å‚™OK (è¿½åŠ :ç´„${addedCount}ä»¶)`;
            document.getElementById('mergeActionArea').classList.remove('hidden');
        } catch(e) {
            alert("ãƒ¡ãƒ¢ãƒªä¸è¶³ã§çµåˆãƒ‡ãƒ¼ã‚¿ã®CSVåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
        }
    }

    function resetUI() {
        const btn = document.getElementById('saveInternalBtn');
        btn.disabled = false;
        btn.innerHTML = `ğŸ’¾ è¿½è¨˜ã—ã¦ã‚¢ãƒ—ãƒªå†…ã«ä¿å­˜`;
    }

    function saveMergedToDB() {
        if(!mergedContent) return;
        const btn = document.getElementById('saveInternalBtn');
        btn.disabled = true;
        btn.innerHTML = "â³ ä¿å­˜ä¸­...";
        
        saveToDB(mergedContent, "merged_data.csv", function() {
            // ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦åæ˜ ã•ã›ã‚‹ã®ãŒä¸€ç•ªãƒ¡ãƒ¢ãƒªã«å„ªã—ã„
            if(confirm("ä¿å­˜ã—ã¾ã—ãŸã€‚åæ˜ ã™ã‚‹ãŸã‚ã«ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã‹ï¼Ÿ")) {
                location.reload();
            } else {
                resetUI();
            }
        });
    }

    function downloadMergedCSV() {
        const blob = new Blob([new Uint8Array([0xEF, 0xBB, 0xBF]), mergedContent], { type: "text/csv" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "app_data_combined.csv";
        document.body.appendChild(a);
        a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
    }

    // --- ãƒ•ã‚£ãƒ«ã‚¿ãƒ»UIæ“ä½œ (å¤‰æ›´ãªã—) ---
    function setupDateFilter(minYear, maxYear) {
        if (allRecords.length === 0) return;
        const yearSelect = document.getElementById('startYear');
        yearSelect.innerHTML = '';
        if(minYear > maxYear) { minYear = 2000; maxYear = 2025; }
        for (let y = minYear; y <= maxYear; y++) {
            const opt = document.createElement('option');
            opt.value = y; opt.innerText = y; yearSelect.appendChild(opt);
        }
        yearSelect.value = minYear;
        document.getElementById('startMonth').value = 1;
        document.getElementById('periodFilterArea').classList.add('visible');
    }

    function applyDateFilter(refreshUI = true) {
        const sYear = parseInt(document.getElementById('startYear').value);
        const sMonth = parseInt(document.getElementById('startMonth').value);
        const startVal = sYear * 100 + sMonth;
        activeRecords = allRecords.filter(r => {
            return (r.year * 100 + r.month) >= startVal;
        });
        document.getElementById('periodCount').innerText = `å¯¾è±¡: ${activeRecords.length} / ${allRecords.length}ä»¶`;
        if (refreshUI) {
            updateRanking();
            if(!isComparisonMode) searchHorse(); else updateComparison();
        }
    }

    function updateRanking() {
        if (activeRecords.length === 0) {
            document.getElementById('rankingList').innerHTML = '<div style="text-align:center;padding:20px;">ãƒ‡ãƒ¼ã‚¿ãªã—</div>';
            return;
        }
        const place = document.getElementById('placeSelect').value;
        const track = document.getElementById('trackSelect').value;
        const dist = parseInt(document.getElementById('distSelect').value);
        const showOutlier = document.getElementById('outlierCheck').checked;
        
        const filtered = activeRecords.filter(r => {
            return (place === 'å…¨ã¦' || r.place === place) && (r.track === track) && (r.distance === dist) && (showOutlier ? true : !r.is_outlier);
        });
        filtered.sort((a, b) => a.seconds - b.seconds);
        renderList(filtered.slice(0, 100), 'rankingList', true);
    }

    function searchHorse() {
        isComparisonMode = false;
        document.getElementById('searchFilterArea').classList.add('hidden');
        document.getElementById('searchResultTitle').style.display = "block";
        const query = document.getElementById('searchInput').value;
        if (!query) { document.getElementById('searchList').innerHTML = ''; return; }
        const hits = [...new Set(activeRecords.map(r => r.horse_name))].filter(n => n.includes(query)).sort();
        const container = document.getElementById('searchList');
        container.innerHTML = '';
        hits.forEach(name => {
            const div = document.createElement('div');
            div.className = 'record-item'; div.style.cursor = 'pointer';
            const isSel = selectedHorses.has(name);
            div.innerHTML = `<span class="horse-name">${name}</span> ${isSel ? 'âœ”' : 'ï¼‹'}`;
            div.onclick = () => toggleSelectHorse(name);
            container.appendChild(div);
        });
    }

    function toggleSelectHorse(name) {
        if (selectedHorses.has(name)) selectedHorses.delete(name); else selectedHorses.add(name);
        updateSelectedArea();
        if (!isComparisonMode) searchHorse(); else updateComparison();
    }

    function updateSelectedArea() {
        const c = document.getElementById('selectedTags');
        const a = document.getElementById('selectedArea');
        if (selectedHorses.size === 0) { a.style.display = 'none'; return; }
        a.style.display = 'block'; c.innerHTML = '';
        selectedHorses.forEach(name => {
            const t = document.createElement('div'); t.className = 'horse-tag';
            t.innerHTML = `${name} <span class="remove-btn" onclick="toggleSelectHorse('${name}')">Ã—</span>`;
            c.appendChild(t);
        });
    }

    function showComparison() {
        isComparisonMode = true;
        document.getElementById('searchFilterArea').classList.remove('hidden');
        updateComparison();
    }

    function updateComparison() {
        if (!isComparisonMode) return;
        const place = document.getElementById('s_placeSelect').value;
        const track = document.getElementById('s_trackSelect').value;
        const dist = document.getElementById('s_distSelect').value;
        const showOutlier = document.getElementById('s_outlierCheck').checked;
        let f = activeRecords.filter(r => selectedHorses.has(r.horse_name));
        f = f.filter(r => {
            return (place === 'å…¨ã¦' || r.place === place) && (track === 'å…¨ã¦' || r.track === track) && (dist === 'å…¨ã¦' || r.distance === parseInt(dist)) && (showOutlier ? true : !r.is_outlier);
        });
        f.sort((a, b) => a.seconds - b.seconds);
        renderList(f, 'searchList', false, true);
    }

    function renderList(data, targetId, isRank, hl) {
        const c = document.getElementById(targetId); c.innerHTML = '';
        if (data.length === 0) { c.innerHTML = '<div style="text-align:center;">è©²å½“ãªã—</div>'; return; }
        // æç”»ã‚³ã‚¹ãƒˆå‰Šæ¸›ã®ãŸã‚æœ€å¤§è¡¨ç¤ºæ•°ã‚’åˆ¶é™ã™ã‚‹æ‰‹ã‚‚ã‚ã‚‹ãŒã€ä»Šã¯100ä»¶ã¾ãŸã¯å…¨ä»¶
        data.forEach((r, i) => {
            const div = document.createElement('div'); div.className = 'record-item';
            let rh = '';
            if (isRank) {
                let rc = 'rank-other';
                if (i===0) rc='rank-1'; if(i===1) rc='rank-2'; if(i===2) rc='rank-3';
                rh = `<div class="rank-badge ${rc}">${i+1}</div>`;
            }
            div.innerHTML = `
                <div style="display:flex;align-items:center;">${rh}
                    <div><span class="horse-name" style="${hl?'color:#007aff;':''}">${r.horse_name}</span>
                    <div class="meta-info">${r.date} (${r.place}) <b>${r.track}${r.distance}m</b></div></div>
                </div>
                <div style="text-align:right;">
                    <div class="time-str ${r.is_outlier?'outlier':''}">${r.time_str}</div>
                    <div class="condition">${r.condition}/${r.rank}ç€</div>
                </div>`;
            c.appendChild(div);
        });
    }

    function switchTab(n) {
        document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
        document.querySelectorAll('.content').forEach(c=>c.classList.remove('active'));
        if(n==='ranking') document.querySelectorAll('.tab')[0].classList.add('active');
        else if(n==='search') document.querySelectorAll('.tab')[1].classList.add('active');
        else document.querySelectorAll('.tab')[2].classList.add('active');
        document.getElementById(n).classList.add('active');
    }
</script>
</body>
</html>