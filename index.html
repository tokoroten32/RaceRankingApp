<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç«¶é¦¬ãƒ‡ãƒ¼ã‚¿åˆ†æ Web</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        :root { --base-font-size: 16px; }
        html { font-size: var(--base-font-size); }

        body { font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", sans-serif; margin: 0; padding: 0; background: #f2f2f7; color: #333; }
        
        header { background: #fff; padding: 10px 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #ccc; position: sticky; top: 0; z-index: 100; }
        h1 { margin: 0; font-size: 1.2rem; }
        .version-tag { font-size: 0.7rem; color: #888; font-weight: normal; margin-left: 5px; vertical-align: middle; }

        .settings-btn { background: none; border: 1px solid #ccc; border-radius: 5px; padding: 5px 10px; cursor: pointer; font-size: 0.9rem; color: #555; }
        
        /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 999; display: none; justify-content: center; align-items: center; }
        .modal-box { background: #fff; padding: 20px; border-radius: 10px; width: 90%; max-width: 350px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); display: flex; flex-direction: column; max-height: 80vh; }
        
        .modal-box.help-box { max-width: 600px; }
        .help-content { overflow-y: auto; text-align: left; margin-bottom: 15px; padding-right: 5px; font-size: 0.9rem; line-height: 1.6; }
        .help-section { margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 15px; }
        .help-section:last-child { border-bottom: none; }
        .help-title { font-weight: bold; color: #007aff; margin-bottom: 5px; font-size: 1rem; }

        .modal-title { font-weight: bold; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; font-size: 1.1rem; text-align: center; }
        .menu-item { margin-bottom: 15px; }
        .menu-label { display: block; font-size: 0.9rem; color: #666; margin-bottom: 5px; }
        .menu-control { width: 100%; padding: 8px; font-size: 1rem; border: 1px solid #ddd; border-radius: 5px; }

        .file-area { padding: 15px; background: #fff; margin-bottom: 10px; text-align: center; }
        .status-box { font-size: 0.9rem; color: #666; margin-top: 8px; min-height: 1.5em; font-weight: bold; }
        .status-success { color: #34c759; }
        .status-loading { color: #007aff; }

        .tabs { display: flex; background: #fff; border-bottom: 1px solid #ccc; }
        .tab { flex: 1; padding: 15px; text-align: center; cursor: pointer; color: #888; border-bottom: 3px solid transparent; font-size: 0.9rem; }
        .tab.active { color: #007aff; border-bottom: 3px solid #007aff; font-weight: bold; }
        
        .content { display: none; padding: 15px; }
        .content.active { display: block; }
        
        .filter-group { background: #fff; padding: 15px; border-radius: 10px; margin-bottom: 15px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .filter-row { display: flex; gap: 10px; margin-bottom: 10px; }
        .filter-row:last-child { margin-bottom: 0; }
        select, input[type="text"] { flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 5px; font-size: 1rem; }
        
        .race-picker-area { background: #f9f9f9; padding: 10px; border-radius: 8px; margin-bottom: 15px; border: 1px dashed #ccc; }
        .race-picker-title { font-size: 0.85rem; font-weight: bold; color: #007aff; margin-bottom: 8px; }
        .race-picker-controls { display: flex; gap: 5px; margin-bottom: 5px; }
        .race-picker-controls select { font-size: 0.9rem; padding: 5px; }

        /* ä¸€æ‹¬è¿½åŠ ã‚¨ãƒªã‚¢ */
        .bulk-add-area { margin-top: 15px; border-top: 1px dashed #ccc; padding-top: 10px; }
        .bulk-textarea { width: 100%; height: 80px; padding: 8px; border: 1px solid #ddd; border-radius: 5px; font-size: 0.9rem; box-sizing: border-box; }
        
        .record-list { list-style: none; padding: 0; margin: 0; }
        .record-item { background: #fff; padding: 12px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .record-item:last-child { border-bottom: none; }
        
        .rank-badge { width: 2.2em; height: 2.2em; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; margin-right: 10px; font-size: 0.9rem; flex-shrink: 0; }
        .rank-1 { background: gold; color: #fff; }
        .rank-2 { background: silver; color: #fff; }
        .rank-3 { background: #cd7f32; color: #fff; }
        .rank-other { background: #eee; color: #333; }
        
        .horse-name { font-weight: bold; font-size: 1.1rem; display: block; cursor: pointer; text-decoration: underline; text-decoration-color: rgba(0,0,0,0.2); }
        .horse-name:hover { opacity: 0.7; }
        
        .jockey-name { font-size: 0.8rem; color: #666; margin-left: 5px; font-weight: normal; display: inline-block; }

        .meta-info { font-size: 0.8rem; color: #666; }
        .time-str { font-weight: bold; font-size: 1.2rem; font-family: monospace; }
        .condition { font-size: 0.75rem; color: #999; }
        .outlier { color: red; }
        .ref-text { color: red; font-size: 0.7rem; }
        .history-rank-badge { background-color: #007aff; color: white; font-size: 0.75rem; padding: 2px 6px; border-radius: 4px; margin-left: 5px; vertical-align: middle; }

        .search-box { display: flex; gap: 5px; }
        .selected-horses-area { background: #fff; padding: 10px; border-radius: 10px; margin-bottom: 15px; }
        .tag-container { display: flex; flex-wrap: wrap; gap: 5px; margin-bottom: 10px; }
        .horse-tag { background: #e0f0ff; color: #007aff; padding: 5px 10px; border-radius: 15px; font-size: 0.9rem; display: flex; align-items: center; gap: 5px; border: 1px solid #007aff; }
        .remove-btn { cursor: pointer; font-weight: bold; }
        .btn-compare { width: 100%; padding: 10px; background: #007aff; color: white; border: none; border-radius: 8px; font-size: 1rem; cursor: pointer; }
        .btn-add { background: none; border: none; color: #007aff; font-size: 1.5rem; cursor: pointer; }
        
        .update-box { text-align: center; padding: 20px; border: 2px dashed #ccc; border-radius: 10px; background: #fafafa; margin-bottom: 20px; }
        .btn-primary { background: #007aff; color: white; border: none; padding: 10px 20px; border-radius: 8px; font-size: 1.1rem; cursor: pointer; font-weight: bold; width: 100%; margin-bottom: 10px; }
        .btn-secondary { background: #8e8e93; color: white; border: none; padding: 10px 20px; border-radius: 8px; font-size: 0.9rem; cursor: pointer; width: 100%; }
        .btn-danger { background: #ff3b30; color: white; border: none; padding: 10px 20px; border-radius: 8px; font-size: 0.9rem; cursor: pointer; width: 100%; }
        .btn-help { background: #34c759; color: white; border: none; padding: 10px 20px; border-radius: 8px; font-size: 0.9rem; cursor: pointer; width: 100%; margin-bottom: 10px; }

        .script-area { text-align: left; margin-bottom: 20px; }
        .code-box { width: 100%; height: 100px; font-family: monospace; font-size: 0.8rem; border: 1px solid #ddd; border-radius: 5px; padding: 5px; background: #f0f0f0; color: #555; box-sizing: border-box; resize: vertical; }
        .btn-copy { background: #5856d6; color: white; border: none; padding: 8px 15px; border-radius: 5px; font-size: 0.9rem; cursor: pointer; margin-right: 5px; }
        .btn-colab { background: #f9ab00; color: white; border: none; padding: 8px 15px; border-radius: 5px; font-size: 0.9rem; cursor: pointer; text-decoration: none; display: inline-block; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

<header>
    <h1>ç«¶é¦¬ãƒ‡ãƒ¼ã‚¿åˆ†æ <span id="appVersion" class="version-tag">v6.1</span></h1>
    <button class="settings-btn" onclick="toggleMenu()">âš™ï¸ è¨­å®š</button>
</header>

<div id="menuModal" class="modal-overlay">
    <div class="modal-box">
        <div class="modal-title">è¨­å®š</div>
        <div class="menu-item"><button class="btn-help" onclick="toggleHelp()">ğŸ“– ã‚¢ãƒ—ãƒªã®ä½¿ã„æ–¹ã‚’è¦‹ã‚‹</button></div>
        <div class="menu-item">
            <span class="menu-label">æ–‡å­—ã‚µã‚¤ã‚º</span>
            <select id="fontSizeSelect" class="menu-control" onchange="changeFontSize(this.value)">
                <option value="small">å°</option><option value="medium" selected>ä¸­</option><option value="large">å¤§</option>
            </select>
        </div>
        <div class="menu-item"><span class="menu-label">ãƒ‡ãƒ¼ã‚¿ç®¡ç†</span><button class="btn-danger" onclick="clearDB()">ä¿å­˜æ¸ˆã¿ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤</button></div>
        <button class="btn-secondary" onclick="toggleMenu()">é–‰ã˜ã‚‹</button>
    </div>
</div>

<div id="helpModal" class="modal-overlay">
    <div class="modal-box help-box">
        <div class="modal-title">ğŸ“– ã‚¢ãƒ—ãƒªã®ä½¿ã„æ–¹</div>
        <div class="help-content">
            <div class="help-section"><div class="help-title">1. JRA/åœ°æ–¹ã®åˆ‡æ›¿</div>ã€Œæ‰€å±ã€ãƒ•ã‚£ãƒ«ã‚¿ã§ã€JRAã®ã¿ã€åœ°æ–¹ç«¶é¦¬ã®ã¿ã€ã¾ãŸã¯ä¸¡æ–¹ã‚’è¡¨ç¤ºã™ã‚‹ã‹ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‰ã‚Œã¾ã™ã€‚</div>
            <div class="help-section"><div class="help-title">2. ãƒ©ãƒ³ã‚­ãƒ³ã‚°æ©Ÿèƒ½</div>æ¡ä»¶ã«åˆã†ã‚¿ã‚¤ãƒ ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚æ—¥ä»˜ã®æ¨ªã«é¨æ‰‹åãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</div>
            <div class="help-section"><div class="help-title">3. ãƒ¬ãƒ¼ã‚¹æŒ‡å®šæ¯”è¼ƒ</div>ç‰¹å®šã®æ—¥ä»˜ãƒ»å ´æ‰€ãƒ»ãƒ¬ãƒ¼ã‚¹ã®å‡ºèµ°é¦¬ã‚’ä¸€æ‹¬é¸æŠã§ãã¾ã™ã€‚</div>
        </div>
        <button class="btn-secondary" onclick="toggleHelp()">é–‰ã˜ã‚‹</button>
    </div>
</div>

<div id="historyModal" class="modal-overlay">
    <div class="modal-box" style="max-width: 500px;">
        <div class="modal-title" style="color:#007aff;">
            <span id="historyHorseName"></span> ã®å±¥æ­´
        </div>
        <div id="historyList" class="record-list" style="max-height: 60vh; overflow-y: auto;"></div>
        <button class="btn-secondary" onclick="closeHistoryModal()" style="margin-top:10px;">é–‰ã˜ã‚‹</button>
    </div>
</div>

<div class="file-area">
    <label for="csvFile" style="font-weight:bold;">ãƒ¡ã‚¤ãƒ³ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿</label><br>
    <div style="font-size:0.7rem; color:#888; margin-bottom:5px;">(â€»é¨æ‰‹ãƒ‡ãƒ¼ã‚¿å¯¾å¿œç‰ˆCSVã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„)</div>
    <input type="file" id="csvFile" accept=".csv">
    <div id="fileStatus" class="status-box">ãƒ‡ãƒ¼ã‚¿æœªãƒ­ãƒ¼ãƒ‰</div>
    <div id="periodFilterArea" class="period-area">
        <div style="font-size:0.8rem; font-weight:bold; color:#007aff;">â–¼ å¯¾è±¡æœŸé–“ã®è¨­å®š</div>
        <div class="period-control">
            <select id="startYear" class="period-select" onchange="applyDateFilter()"></select><span>å¹´</span>
            <select id="startMonth" class="period-select" onchange="applyDateFilter()">
                <option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option>
                <option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option>
                <option value="9">9</option><option value="10">10</option><option value="11">11</option><option value="12">12</option>
            </select>
            <span>æœˆ ã€œ <span id="endDateLabel" style="font-weight:bold; color:#007aff;">æœ€æ–°</span></span>
        </div>
        <div id="periodCount" style="font-size:0.7rem; color:#666; margin-top:5px;"></div>
    </div>
</div>

<div class="tabs">
    <div class="tab active" onclick="switchTab('ranking')">ãƒ©ãƒ³ã‚­ãƒ³ã‚°</div>
    <div class="tab" onclick="switchTab('search')">é¦¬æ¤œç´¢ãƒ»æ¯”è¼ƒ</div>
    <div class="tab" onclick="switchTab('update')">ãƒ‡ãƒ¼ã‚¿è¿½åŠ </div>
</div>

<div id="ranking" class="content active">
    <div class="filter-group">
        <div class="filter-row">
            <select id="orgSelect" onchange="updateSelectOptions(); updateRanking();" style="font-weight:bold; color:#007aff;">
                <option value="all">æ‰€å±: å…¨ã¦</option>
                <option value="jra">æ‰€å±: JRAã®ã¿</option>
                <option value="nar">æ‰€å±: åœ°æ–¹ã®ã¿</option>
            </select>
            <select id="placeSelect" onchange="updateDistanceOptions('main'); updateRanking();">
                <option value="-1">å ´æ‰€: å…¨ã¦</option>
            </select>
        </div>
        <div class="filter-row">
            <select id="trackSelect" onchange="updateDistanceOptions('main'); updateRanking();">
            </select>
            <select id="distSelect" onchange="updateRanking()">
            </select>
        </div>
        <div style="display:flex; gap:10px; margin-top:5px;">
            <label style="display:flex; align-items:center; font-size:0.8rem;">
                <input type="checkbox" id="outlierCheck" onchange="updateRanking()" checked> å‚è€ƒè¨˜éŒ²è¾¼
            </label>
            <label style="display:flex; align-items:center; font-size:0.8rem; color:#007aff; font-weight:bold;">
                <input type="checkbox" id="dupCheck" onchange="updateRanking()" checked> åŒä¸€é¦¬ã®é‡è¤‡ã‚’è¡¨ç¤º
            </label>
        </div>
    </div>
    <div id="rankingList" class="record-list">
        <div style="text-align:center; color:#999; padding:20px;">ãƒ‡ãƒ¼ã‚¿æœªãƒ­ãƒ¼ãƒ‰</div>
    </div>
</div>

<div id="search" class="content">
    <div class="filter-group">
        <div class="race-picker-area">
            <div class="race-picker-title">â–¼ éå»ã®ãƒ¬ãƒ¼ã‚¹ã‹ã‚‰ä¸€æ‹¬é¸æŠ</div>
            <div class="race-picker-controls">
                <select id="pickerDate" onchange="updatePickerPlace()" style="flex:2"></select>
                <select id="pickerPlace" onchange="updatePickerRace()" style="flex:1"></select>
                <select id="pickerRace" style="flex:1"></select>
            </div>
            <button class="btn-secondary" onclick="selectHorsesByPicker()" style="font-size:0.9rem; padding:8px; width:100%;">ã“ã®ãƒ¬ãƒ¼ã‚¹ã®é¦¬ã‚’è¿½åŠ </button>
        </div>

        <div class="bulk-add-area">
            <div class="race-picker-title">â–¼ ãƒ†ã‚­ã‚¹ãƒˆã‹ã‚‰ä¸€æ‹¬è¿½åŠ ï¼ˆå‡ºé¦¬è¡¨ãªã©ï¼‰</div>
            <textarea id="bulkNameInput" class="bulk-textarea" placeholder="ã“ã“ã«é¦¬åã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ï¼ˆæ”¹è¡ŒåŒºåˆ‡ã‚Šï¼‰"></textarea>
            <button class="btn-primary" onclick="addBulkHorses()" style="margin-top:5px; padding:8px; font-size:0.9rem;">ãƒªã‚¹ãƒˆã®é¦¬ã‚’ä¸€æ‹¬è¿½åŠ </button>
        </div>

        <div class="search-box" style="margin-top:15px;">
            <input type="text" id="searchInput" placeholder="é¦¬åã‚’å…¥åŠ› (ä¾‹: ãƒ‰ã‚¦ãƒ‡ãƒ¥ãƒ¼ã‚¹)" oninput="searchHorse()">
        </div>
    </div>
    <div class="selected-horses-area" id="selectedArea" style="display:none;">
        <div class="tag-container" id="selectedTags"></div>
        <button class="btn-compare" onclick="showComparison()">ã“ã®ãƒ¡ãƒ³ãƒãƒ¼ã®å±¥æ­´ã‚’æ¯”è¼ƒ</button>
    </div>
    <div id="searchFilterArea" class="filter-group hidden">
        <div style="font-size:0.8rem; color:#007aff; margin-bottom:8px; font-weight:bold;">â–¼ çµã‚Šè¾¼ã¿æ¡ä»¶</div>
        <div class="filter-row">
            <select id="s_orgSelect" onchange="updateSelectOptions(); updateComparison();" style="font-weight:bold; color:#007aff;">
                <option value="all">æ‰€å±: å…¨ã¦</option>
                <option value="jra">æ‰€å±: JRAã®ã¿</option>
                <option value="nar">æ‰€å±: åœ°æ–¹ã®ã¿</option>
            </select>
            <select id="s_placeSelect" onchange="updateDistanceOptions('search'); updateComparison();">
                <option value="-1">å ´æ‰€: å…¨ã¦</option>
            </select>
        </div>
        <div class="filter-row">
            <select id="s_trackSelect" onchange="updateDistanceOptions('search'); updateComparison();">
            </select>
            <select id="s_distSelect" onchange="updateComparison()">
            </select>
        </div>
        <div style="display:flex; gap:10px; margin-top:5px;">
            <label style="display:flex; align-items:center; font-size:0.8rem;">
                <input type="checkbox" id="s_outlierCheck" onchange="updateComparison()" checked> å‚è€ƒè¨˜éŒ²è¾¼
            </label>
            <label style="display:flex; align-items:center; font-size:0.8rem; color:#007aff; font-weight:bold;">
                <input type="checkbox" id="s_dupCheck" onchange="updateComparison()" checked> åŒä¸€é¦¬ã®é‡è¤‡ã‚’è¡¨ç¤º
            </label>
        </div>
    </div>
    <div id="searchResultTitle" style="margin: 10px 0; font-weight:bold; display:none;">æ¤œç´¢çµæœ</div>
    <div id="searchList" class="record-list"></div>
</div>

<div id="update" class="content">
    <div class="filter-group">
        <h3 style="margin-top:0;">1. æ–°ãƒ‡ãƒ¼ã‚¿ã®å–å¾—</h3>
        <p style="font-size:0.9rem; color:#666;">Google Colabã§ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã—ã€CSV(ä¾‹: new_data.csv)ã‚’å–å¾—ã—ã¾ã™ã€‚</p>
        <div class="script-area">
            <textarea id="pythonCode" class="code-box" readonly></textarea>
            <div style="margin-top:5px; text-align:center;">
                <button class="btn-copy" onclick="copyScript()">ğŸ“‹ ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼</button>
                <a href="https://colab.research.google.com/drive/1TfY2_4jYqZpT_xwDX_Wp0u2c0JiQJ-gz?usp=sharing" target="_blank" class="btn-colab">ğŸš€ Colabã‚’é–‹ã</a>
            </div>
        </div>
    </div>
    <div class="filter-group">
        <h3 style="margin-top:0;">2. æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã«è¿½è¨˜</h3>
        <p style="font-size:0.9rem; color:#666;">æ–°ã—ãå–å¾—ã—ãŸCSVã‚’é¸æŠã—ã€ã€Œã‚¢ãƒ—ãƒªå†…ã«ä¿å­˜ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚</p>
        <div class="update-box">
            <label style="display:block; margin-bottom:10px; font-weight:bold;">è¿½åŠ ã™ã‚‹CSV (new_data.csv)</label>
            <input type="file" id="updateFile" accept=".csv">
        </div>
        <div id="updateResult" style="margin-bottom:20px; font-weight:bold; color:#007aff;"></div>
        <div id="mergeActionArea" class="hidden">
            <button id="saveInternalBtn" class="btn-primary" onclick="saveMergedToDB()">ğŸ’¾ è¿½è¨˜ã—ã¦ã‚¢ãƒ—ãƒªå†…ã«ä¿å­˜</button>
            <div style="margin-top:15px; border-top:1px solid #eee; padding-top:15px;">
                <button id="downloadBtn" class="btn-secondary" onclick="downloadMergedCSV()">CSVãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦æ›¸ãå‡ºã—</button>
            </div>
        </div>
    </div>
</div>

<script>
    // JRAã®å ´æ‰€å®šç¾©
    const JRA_TRACKS = new Set(["æœ­å¹Œ", "å‡½é¤¨", "ç¦å³¶", "æ–°æ½Ÿ", "æ±äº¬", "ä¸­å±±", "ä¸­äº¬", "äº¬éƒ½", "é˜ªç¥", "å°å€‰"]);

    const DB = {
        ids: [], dates: [], places: [], tracks: [], dists: [], 
        conditions: [], ranks: [], names: [], jockeys: [],
        times: [], time_strs: [], outliers: [],
        validIndices: []
    };

    const Dicts = {
        place: { list: ["ãã®ä»–"], map: {"ãã®ä»–":0} },
        track: { list: ["èŠ"],     map: {"èŠ":0} },
        cond:  { list: ["-"],      map: {"-":0} }
    };

    let selectedHorses = new Set();
    let isComparisonMode = false;
    let currentRankMap = new Map();
    let horseNameSet = new Set(); 
    
    const IDB_NAME = 'KeibaAppDB';
    const IDB_VER = 3;
    const STORE_NAME = 'csvStore';
    let db;
    let mergedContentBlob = null; 

    function getHorseColor(name) {
        let hash = 0;
        for (let i = 0; i < name.length; i++) hash = name.charCodeAt(i) + ((hash << 5) - hash);
        const h = Math.abs(hash) % 360;
        return `hsl(${h}, 75%, 35%)`; 
    }

    const pythonScriptContent = `# Google Colab Script (ç•¥)
def get_race_details(race_id):
    # ... (ç•¥) ...
`;

    window.onload = function() {
        openDB();
        document.getElementById('pythonCode').value = pythonScriptContent;
        const savedSize = localStorage.getItem('keiba_font_size') || 'medium';
        document.getElementById('fontSizeSelect').value = savedSize;
        changeFontSize(savedSize);
    };

    function copyScript() {
        const c = document.getElementById("pythonCode"); c.select();
        navigator.clipboard.writeText(c.value).then(()=>alert("ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ"));
    }

    function toggleMenu() {
        const m = document.getElementById('menuModal');
        m.style.display = (m.style.display === 'flex') ? 'none' : 'flex';
    }
    
    function toggleHelp() {
        const h = document.getElementById('helpModal');
        h.style.display = (h.style.display === 'flex') ? 'none' : 'flex';
        if(h.style.display === 'flex') document.getElementById('menuModal').style.display = 'none';
    }

    function showHorseHistory(name, event) {
        if(event) event.stopPropagation();
        
        document.getElementById('historyHorseName').innerText = name;
        document.getElementById('historyHorseName').style.color = getHorseColor(name);
        
        let currentDist = -1;
        if (document.getElementById('ranking').classList.contains('active')) {
            const val = document.getElementById('distSelect').value;
            currentDist = (val === '-1') ? -1 : parseInt(val);
        } else if (document.getElementById('search').classList.contains('active')) {
            const val = document.getElementById('s_distSelect').value;
            currentDist = (val === '-1') ? -1 : parseInt(val);
        }

        let targetIndices = [];
        for(let i=0; i<DB.names.length; i++) {
            if(DB.names[i] === name) targetIndices.push(i);
        }
        
        let sameDistGroup = [];
        let otherDistGroup = [];

        targetIndices.forEach(idx => {
            if (currentDist !== -1) {
                if (DB.dists[idx] === currentDist) {
                    sameDistGroup.push(idx);
                } else {
                    otherDistGroup.push(idx);
                }
            } else {
                sameDistGroup.push(idx);
            }
        });
        
        sameDistGroup.sort((a,b) => DB.times[a] - DB.times[b]);
        otherDistGroup.sort((a,b) => DB.times[a] - DB.times[b]);
        
        const listEl = document.getElementById('historyList');
        listEl.innerHTML = '';
        
        if(sameDistGroup.length === 0 && otherDistGroup.length === 0) {
            listEl.innerHTML = '<div style="padding:10px;">ãƒ‡ãƒ¼ã‚¿ãªã—</div>';
        } else {
            if (sameDistGroup.length > 0) {
                if (currentDist !== -1 && otherDistGroup.length > 0) {
                    listEl.innerHTML += `<div style="font-size:0.85rem; font-weight:bold; color:#333; background:#e0f0ff; padding:5px 10px; border-left:4px solid #007aff;">â–¼ åŒè·é›¢ (${currentDist}m)</div>`;
                }
                sameDistGroup.forEach(idx => renderHistoryItem(idx, listEl));
            }

            if (otherDistGroup.length > 0) {
                listEl.innerHTML += `<div style="font-size:0.85rem; font-weight:bold; color:#666; background:#eee; padding:5px 10px; margin-top:10px; border-left:4px solid #999;">â–¼ å‚è€ƒ (ä»–è·é›¢)</div>`;
                otherDistGroup.forEach(idx => renderHistoryItem(idx, listEl));
            }
        }
        
        document.getElementById('historyModal').style.display = 'flex';
    }

    function closeHistoryModal() {
        document.getElementById('historyModal').style.display = 'none';
    }

    function renderHistoryItem(idx, container) {
        const dateInt = DB.dates[idx];
        const y = Math.floor(dateInt/10000);
        const m = Math.floor((dateInt%10000)/100);
        const d = dateInt%100;
        const dateStr = `${y}å¹´${m}æœˆ${d}æ—¥`;
        const placeStr = Dicts.place.list[DB.places[idx]];
        const trackStr = Dicts.track.list[DB.tracks[idx]];
        const condStr = Dicts.cond.list[DB.conditions[idx]];
        const jockey = DB.jockeys[idx] || "";
        
        let rankBadge = "";
        if (currentRankMap.has(idx)) {
            const rank = currentRankMap.get(idx);
            rankBadge = `<span class="history-rank-badge">No.${rank}</span>`;
        }
        
        const div = document.createElement('div');
        div.className = 'record-item';
        div.innerHTML = `
            <div>
                <div class="meta-info">${dateStr} (${placeStr}) <span class="jockey-name">(${jockey})</span></div>
                <div style="font-weight:bold;">${trackStr} ${DB.dists[idx]}m ${rankBadge}</div>
            </div>
            <div style="text-align:right;">
                <div class="time-str">${DB.time_strs[idx]}</div>
                <div class="condition">${condStr} / ${DB.ranks[idx]}ç€</div>
            </div>`;
        container.appendChild(div);
    }

    function changeFontSize(size) {
        let pxVal = '16px';
        if (size === 'small') pxVal = '13px';
        if (size === 'large') pxVal = '20px';
        document.documentElement.style.setProperty('--base-font-size', pxVal);
        localStorage.setItem('keiba_font_size', size);
    }

    function getDictId(type, val) {
        val = (val || "").trim();
        if(!val) return 0; 
        const dic = Dicts[type];
        if(dic.map.hasOwnProperty(val)) return dic.map[val];
        const idx = dic.list.length;
        dic.list.push(val);
        dic.map[val] = idx;
        return idx;
    }

    function openDB() {
        const req = indexedDB.open(IDB_NAME, IDB_VER);
        req.onupgradeneeded = function(e) {
            db = e.target.result;
            if (db.objectStoreNames.contains(STORE_NAME)) db.deleteObjectStore(STORE_NAME);
            db.createObjectStore(STORE_NAME, { keyPath: 'id' });
        };
        req.onsuccess = function(e) {
            db = e.target.result;
            loadFromDB();
        };
        req.onerror = function() { console.error("DB Error"); };
    }

    function saveToDB(fileOrBlob, fileName, callback) {
        if (!db) return;
        const tx = db.transaction([STORE_NAME], 'readwrite');
        const store = tx.objectStore(STORE_NAME);
        const data = { id: 'mainCSV', content: fileOrBlob, fileName: fileName, date: new Date().toLocaleString() };
        const req = store.put(data);
        req.onsuccess = function() {
            document.getElementById('fileStatus').innerHTML = `<span class="status-success">ä¿å­˜å®Œäº† (${data.date})</span>`;
            if(callback) callback();
        };
        req.onerror = function(e) { alert("ä¿å­˜å¤±æ•—: " + e.target.error.message); };
    }

    function loadFromDB() {
        const tx = db.transaction([STORE_NAME], 'readonly');
        const store = tx.objectStore(STORE_NAME);
        store.get('mainCSV').onsuccess = function(e) {
            const res = e.target.result;
            if (res) {
                document.getElementById('fileStatus').innerHTML = `<span class="status-loading">å±•é–‹ä¸­...</span>`;
                setTimeout(() => {
                    loadCSV(res.content, false);
                    document.getElementById('fileStatus').innerHTML = `<span class="status-success">å¾©å…ƒå®Œäº† (${res.date})</span>`;
                    document.getElementById('clearDataArea').classList.remove('hidden'); 
                }, 100);
            } else {
                document.getElementById('fileStatus').innerText = "ãƒ‡ãƒ¼ã‚¿æœªãƒ­ãƒ¼ãƒ‰";
            }
        };
    }

    function clearDB() {
        if(!confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
        const tx = db.transaction([STORE_NAME], 'readwrite');
        tx.objectStore(STORE_NAME).delete('mainCSV');
        location.reload();
    }

    document.getElementById('csvFile').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if(!file) return;
        loadCSV(file, true);
    });

    function loadCSV(file, shouldSave) {
        DB.ids=[]; DB.dates=[]; DB.places=[]; DB.tracks=[]; DB.dists=[]; 
        DB.conditions=[]; DB.ranks=[]; DB.names=[]; DB.jockeys=[];
        DB.times=[]; DB.time_strs=[]; DB.outliers=[];
        DB.validIndices=[];
        Dicts.place={list:["ãã®ä»–"],map:{"ãã®ä»–":0}};
        Dicts.track={list:["èŠ"],map:{"èŠ":0}};
        Dicts.cond={list:["-"],map:{"-":0}};
        horseNameSet.clear(); 

        let minYear = 9999, maxYear = 0;
        let maxDateVal = 0; 

        document.getElementById('fileStatus').innerHTML = '<span class="status-loading">è§£æä¸­...</span>';

        Papa.parse(file, {
            header: true,
            skipEmptyLines: true,
            step: function(row) {
                const r = row.data;
                if (!r.race_id) return;

                DB.ids.push(r.race_id);
                DB.names.push(r.horse_name || "");
                if(r.horse_name) horseNameSet.add(r.horse_name); 
                
                DB.jockeys.push(r.jockey || ""); 
                DB.time_strs.push(r.time_str || "");
                
                DB.places.push(getDictId("place", r.place));
                DB.tracks.push(getDictId("track", r.track));
                DB.conditions.push(getDictId("cond", r.condition));

                DB.dists.push(parseInt(r.distance) || 0);
                DB.ranks.push(parseInt(r.rank) || 0);
                DB.times.push(parseFloat(r.seconds) || 9999);
                
                const isOut = (r.is_outlier === 'True' || r.is_outlier === 'true') ? 1 : 0;
                DB.outliers.push(isOut);

                let y = 0, m = 0, d = 0;
                if(r.date) {
                    const mRes = r.date.match(/(\d+)å¹´(\d+)æœˆ(\d+)æ—¥/);
                    if(mRes) {
                        y = parseInt(mRes[1]); m = parseInt(mRes[2]); d = parseInt(mRes[3]);
                        if(y < minYear) minYear = y;
                        if(y > maxYear) maxYear = y;
                    }
                }
                const dateInt = y * 10000 + m * 100 + d;
                if(dateInt > maxDateVal) maxDateVal = dateInt;
                DB.dates.push(dateInt);
            },
            complete: function() {
                if (shouldSave) {
                    const blob = (file instanceof File || file instanceof Blob) ? file : new Blob([file], {type:'text/csv'});
                    saveToDB(blob, file.name || "data.csv");
                }
                updateSelectOptions(); 
                setupDateFilter(minYear, maxYear, maxDateVal);
                applyDateFilter(true);
                initRacePicker(); 
            },
            error: function(err) { alert("ã‚¨ãƒ©ãƒ¼: " + err.message); }
        });
    }

    function updateSelectOptions() {
        const updateSel = (id, orgId) => {
            const el = document.getElementById(id);
            const orgVal = document.getElementById(orgId).value; // "all", "jra", "nar"
            
            el.innerHTML = '<option value="-1">å ´æ‰€: å…¨ã¦</option>';
            
            Dicts.place.list.forEach((val, i) => {
                if(val === "-") return;
                
                const isJra = JRA_TRACKS.has(val);
                
                if (orgVal === "jra" && !isJra) return;
                if (orgVal === "nar" && isJra) return;
                
                const opt = document.createElement('option');
                opt.value = i; opt.innerText = val; el.appendChild(opt);
            });
        };
        
        updateSel('placeSelect', 'orgSelect');
        updateSel('s_placeSelect', 's_orgSelect');
        
        const updateTrack = (id) => {
            const el = document.getElementById(id);
            el.innerHTML = '<option value="-1">ãƒˆãƒ©ãƒƒã‚¯: å…¨ã¦</option>';
            Dicts.track.list.forEach((val, i) => {
                if(val === "-") return;
                const opt = document.createElement('option');
                opt.value = i; opt.innerText = val; el.appendChild(opt);
            });
        };
        updateTrack('trackSelect');
        updateTrack('s_trackSelect');

        updateDistanceOptions('main');
        updateDistanceOptions('search');
    }

    // â˜…ä¿®æ­£: ãƒ‡ãƒ¼ã‚¿é§†å‹•å‹ã®å‹•çš„è·é›¢ã‚ªãƒ—ã‚·ãƒ§ãƒ³ç”Ÿæˆ
    function updateDistanceOptions(mode) {
        const pId = (mode === 'main') ? 'placeSelect' : 's_placeSelect';
        const tId = (mode === 'main') ? 'trackSelect' : 's_trackSelect';
        const dId = (mode === 'main') ? 'distSelect' : 's_distSelect';
        const orgId = (mode === 'main') ? 'orgSelect' : 's_orgSelect';

        const placeIdx = parseInt(document.getElementById(pId).value);
        const trackIdx = parseInt(document.getElementById(tId).value);
        const orgVal = document.getElementById(orgId).value;

        // DBå…¨ä½“ã‹ã‚‰ã€ç¾åœ¨ã®æ¡ä»¶ã«åˆã†è·é›¢ã‚’åé›†ã™ã‚‹
        const availableDists = new Set();
        
        // é«˜é€ŸåŒ–ã®ãŸã‚ã€å¯¾è±¡ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’çµã‚‹
        const indices = DB.validIndices;
        for(let k=0; k<indices.length; k++) {
            const i = indices[k];
            
            // æ‰€å±ãƒ•ã‚£ãƒ«ã‚¿
            if (orgVal !== 'all') {
                const pName = Dicts.place.list[DB.places[i]];
                const isJra = JRA_TRACKS.has(pName);
                if (orgVal === 'jra' && !isJra) continue;
                if (orgVal === 'nar' && isJra) continue;
            }

            // å ´æ‰€ãƒ•ã‚£ãƒ«ã‚¿
            if (placeIdx !== -1 && DB.places[i] !== placeIdx) continue;

            // ãƒˆãƒ©ãƒƒã‚¯ãƒ•ã‚£ãƒ«ã‚¿
            if (trackIdx !== -1 && DB.tracks[i] !== trackIdx) continue;

            // æ¡ä»¶ã«åˆè‡´ã—ãŸã®ã§è·é›¢ã‚’è¿½åŠ 
            availableDists.add(DB.dists[i]);
        }

        const sortedDists = Array.from(availableDists).sort((a,b) => a - b);

        const distSelect = document.getElementById(dId);
        const currentVal = distSelect.value;
        distSelect.innerHTML = '<option value="-1">è·é›¢: å…¨ã¦</option>';
        
        sortedDists.forEach(d => {
            const opt = document.createElement('option');
            opt.value = d; opt.innerText = d + "m"; distSelect.appendChild(opt);
        });

        if (currentVal !== "-1" && sortedDists.includes(parseInt(currentVal))) {
            distSelect.value = currentVal;
        } else {
            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ãƒã‚¤ãƒ«ã‹è¿‘ã„è·é›¢ãŒã‚ã‚Œã°é¸ã³ãŸã„ãŒã€ã“ã“ã§ã¯ã€Œå…¨ã¦ã€ã«æˆ»ã™ã®ãŒç„¡é›£
            distSelect.value = "-1";
        }
    }

    function setupDateFilter(minYear, maxYear, maxDateVal) {
        if(minYear > 2100) { minYear = 2020; maxYear = 2025; }
        const sel = document.getElementById('startYear');
        sel.innerHTML = '';
        for(let y=minYear; y<=maxYear; y++) {
            const opt = document.createElement('option');
            opt.value = y; opt.innerText = y; sel.appendChild(opt);
        }
        sel.value = minYear;
        document.getElementById('startMonth').value = 1;
        document.getElementById('periodFilterArea').classList.add('visible');

        const endLabel = document.getElementById('endDateLabel');
        if(maxDateVal > 0) {
            const y = Math.floor(maxDateVal / 10000);
            const m = Math.floor((maxDateVal % 10000) / 100);
            const d = maxDateVal % 100;
            endLabel.innerText = `${y}å¹´${m}æœˆ${d}æ—¥`;
        } else { endLabel.innerText = "æœ€æ–°"; }
    }

    function applyDateFilter(refreshUI = true) {
        const sYear = parseInt(document.getElementById('startYear').value);
        const sMonth = parseInt(document.getElementById('startMonth').value);
        const startVal = sYear * 10000 + sMonth * 100 + 1; 

        DB.validIndices = [];
        const len = DB.dates.length;
        for(let i=0; i<len; i++) {
            if (DB.dates[i] >= startVal) DB.validIndices.push(i);
        }
        document.getElementById('periodCount').innerText = `å¯¾è±¡: ${DB.validIndices.length} / ${len}ä»¶`;
        if(refreshUI) {
            updateRanking();
            if(!isComparisonMode) searchHorse(); else updateComparison();
        }
    }

    function updateRanking() {
        if (DB.validIndices.length === 0) {
            document.getElementById('rankingList').innerHTML = '<div style="text-align:center;padding:20px;">ãƒ‡ãƒ¼ã‚¿ãªã—</div>';
            return;
        }
        
        const orgVal = document.getElementById('orgSelect').value;
        const pFilter = parseInt(document.getElementById('placeSelect').value);
        const tFilter = parseInt(document.getElementById('trackSelect').value);
        const dVal = document.getElementById('distSelect').value;
        const dFilter = (dVal === '-1') ? -1 : parseInt(dVal);
        const showOutlier = document.getElementById('outlierCheck').checked;
        const showDup = document.getElementById('dupCheck').checked;

        let matched = [];
        const indices = DB.validIndices;
        for(let k=0; k<indices.length; k++) {
            const i = indices[k];
            
            if (orgVal !== 'all') {
                const pName = Dicts.place.list[DB.places[i]];
                const isJra = JRA_TRACKS.has(pName);
                if (orgVal === 'jra' && !isJra) continue;
                if (orgVal === 'nar' && isJra) continue;
            }

            if (pFilter !== -1 && DB.places[i] !== pFilter) continue;
            if (tFilter !== -1 && DB.tracks[i] !== tFilter) continue;
            if (dFilter !== -1 && DB.dists[i] !== dFilter) continue;
            if (!showOutlier && DB.outliers[i] === 1) continue;
            matched.push(i);
        }
        matched.sort((a, b) => DB.times[a] - DB.times[b]);

        if (!showDup) {
            const uniqueMatched = [];
            const seenHorses = new Set();
            for (let i = 0; i < matched.length; i++) {
                const idx = matched[i];
                const name = DB.names[idx];
                if (!seenHorses.has(name)) {
                    seenHorses.add(name);
                    uniqueMatched.push(idx);
                }
            }
            matched = uniqueMatched;
        }
        
        currentRankMap.clear();
        matched.forEach((dbIdx, rank) => {
            currentRankMap.set(dbIdx, rank + 1);
        });
        
        let nameCounts = {};
        matched.forEach(i => {
            let n = DB.names[i];
            nameCounts[n] = (nameCounts[n] || 0) + 1;
        });

        renderList(matched.slice(0, 100), 'rankingList', true, nameCounts);
    }

    function initRacePicker() {
        const dates = [...new Set(DB.dates)].sort((a,b)=>b-a);
        const dSel = document.getElementById('pickerDate');
        dSel.innerHTML = '';
        dates.forEach(d => {
            const y = Math.floor(d/10000);
            const m = Math.floor((d%10000)/100);
            const da = d%100;
            const opt = document.createElement('option');
            opt.value = d;
            opt.innerText = `${y}/${m}/${da}`;
            dSel.appendChild(opt);
        });
        updatePickerPlace();
    }

    function updatePickerPlace() {
        const dateVal = parseInt(document.getElementById('pickerDate').value);
        const places = new Set();
        for(let i=0; i<DB.dates.length; i++) {
            if(DB.dates[i] === dateVal) places.add(DB.places[i]);
        }
        const pSel = document.getElementById('pickerPlace');
        pSel.innerHTML = '';
        places.forEach(pIdx => {
            const opt = document.createElement('option');
            opt.value = pIdx;
            opt.innerText = Dicts.place.list[pIdx];
            pSel.appendChild(opt);
        });
        updatePickerRace();
    }

    function updatePickerRace() {
        const dateVal = parseInt(document.getElementById('pickerDate').value);
        const placeIdx = parseInt(document.getElementById('pickerPlace').value);
        const races = new Set();
        for(let i=0; i<DB.dates.length; i++) {
            if(DB.dates[i] === dateVal && DB.places[i] === placeIdx) {
                const rid = DB.ids[i];
                if(rid.length >= 12) {
                    const rNum = parseInt(rid.substring(10, 12));
                    races.add(rNum);
                }
            }
        }
        const rSel = document.getElementById('pickerRace');
        rSel.innerHTML = '';
        const sortedRaces = [...races].sort((a,b)=>a-b);
        sortedRaces.forEach(r => {
            const opt = document.createElement('option');
            opt.value = r;
            opt.innerText = r + "R";
            rSel.appendChild(opt);
        });
    }

    function selectHorsesByPicker() {
        const dateVal = parseInt(document.getElementById('pickerDate').value);
        const placeIdx = parseInt(document.getElementById('pickerPlace').value);
        const raceNum = parseInt(document.getElementById('pickerRace').value);
        
        let count = 0;
        selectedHorses.clear(); 
        
        for(let i=0; i<DB.dates.length; i++) {
            if(DB.dates[i] === dateVal && DB.places[i] === placeIdx) {
                const rid = DB.ids[i];
                if(rid.length >= 12) {
                    const r = parseInt(rid.substring(10, 12));
                    if(r === raceNum) {
                        selectedHorses.add(DB.names[i]);
                        count++;
                    }
                }
            }
        }
        
        if(count > 0) {
            updateSelectedArea();
            alert(`${count}é ­ã‚’ãƒªã‚¹ãƒˆã«è¿½åŠ ã—ã¾ã—ãŸã€‚\nã€Œå±¥æ­´ã‚’æ¯”è¼ƒã€ãƒœã‚¿ãƒ³ã§è©³ç´°ã‚’ç¢ºèªã§ãã¾ã™ã€‚`);
        } else {
            alert("è©²å½“ã™ã‚‹é¦¬ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚");
        }
    }

    function addBulkHorses() {
        const text = document.getElementById('bulkNameInput').value;
        if (!text) return;
        
        const lines = text.split('\n');
        let successCount = 0;
        let failCount = 0;
        let failedNames = [];
        
        lines.forEach(line => {
            const name = line.trim();
            if (!name) return;

            if (horseNameSet.has(name)) {
                if(!selectedHorses.has(name)) {
                    selectedHorses.add(name);
                    successCount++;
                }
            } else {
                failCount++;
                if(failedNames.length < 5) failedNames.push(name); 
            }
        });
        
        if (successCount > 0) {
            updateSelectedArea();
            document.getElementById('bulkNameInput').value = ''; 
            
            let msg = `${successCount}é ­ã‚’è¿½åŠ ã—ã¾ã—ãŸã€‚`;
            if(failCount > 0) {
                msg += `\n(${failCount}é ­ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ: ${failedNames.join(', ')} ãªã©)`;
            }
            alert(msg);
        } else {
            alert(`è¿½åŠ ã§ãã‚‹é¦¬ãŒã„ã¾ã›ã‚“ã§ã—ãŸã€‚\n(å…¥åŠ›ã•ã‚ŒãŸ ${failCount}é ­ã¯ã™ã¹ã¦ãƒ‡ãƒ¼ã‚¿ã«å­˜åœ¨ã—ã¾ã›ã‚“)`);
        }
    }

    function searchHorse() {
        isComparisonMode = false;
        document.getElementById('searchFilterArea').classList.add('hidden');
        document.getElementById('searchResultTitle').style.display = 'block';
        
        const query = document.getElementById('searchInput').value;
        if (!query) { document.getElementById('searchList').innerHTML = ''; return; }

        const hits = new Set();
        const indices = DB.validIndices;
        for(let k=0; k<indices.length; k++) {
            const i = indices[k];
            const name = DB.names[i];
            if (name.includes(query)) hits.add(name);
        }
        const hitNames = Array.from(hits).sort();

        const c = document.getElementById('searchList');
        c.innerHTML = '';
        hitNames.forEach(name => {
            const div = document.createElement('div');
            div.className = 'record-item'; div.style.cursor = 'pointer';
            const isSel = selectedHorses.has(name);
            div.innerHTML = `<span class="horse-name">${name}</span> ${isSel ? 'âœ”' : 'ï¼‹'}`;
            div.onclick = () => toggleSelectHorse(name);
            c.appendChild(div);
        });
    }

    function toggleSelectHorse(name) {
        if (selectedHorses.has(name)) selectedHorses.delete(name); else selectedHorses.add(name);
        updateSelectedArea();
        if(!isComparisonMode) searchHorse(); else updateComparison();
    }

    function updateSelectedArea() {
        const c = document.getElementById('selectedTags');
        const a = document.getElementById('selectedArea');
        if(selectedHorses.size === 0) { a.style.display='none'; return; }
        a.style.display='block'; c.innerHTML='';
        selectedHorses.forEach(n => {
            const t = document.createElement('div'); t.className='horse-tag';
            t.innerHTML = `${n} <span class="remove-btn" onclick="toggleSelectHorse('${n}')">Ã—</span>`;
            c.appendChild(t);
        });
    }

    function showComparison() {
        isComparisonMode = true;
        document.getElementById('searchFilterArea').classList.remove('hidden');
        updateComparison();
    }

    function updateComparison() {
        if(!isComparisonMode) return;
        
        const orgVal = document.getElementById('s_orgSelect').value;
        const pFilter = parseInt(document.getElementById('s_placeSelect').value);
        const tFilter = parseInt(document.getElementById('s_trackSelect').value);
        const dVal = document.getElementById('s_distSelect').value;
        const dFilter = (dVal === '-1') ? -1 : parseInt(dVal);
        const showOutlier = document.getElementById('s_outlierCheck').checked;
        const showDup = document.getElementById('s_dupCheck').checked;

        let matched = [];
        const indices = DB.validIndices;
        for(let k=0; k<indices.length; k++) {
            const i = indices[k];
            if (!selectedHorses.has(DB.names[i])) continue;
            
            if (orgVal !== 'all') {
                const pName = Dicts.place.list[DB.places[i]];
                const isJra = JRA_TRACKS.has(pName);
                if (orgVal === 'jra' && !isJra) continue;
                if (orgVal === 'nar' && isJra) continue;
            }

            if (pFilter !== -1 && DB.places[i] !== pFilter) continue;
            if (tFilter !== -1 && DB.tracks[i] !== tFilter) continue;
            if (dFilter !== -1 && DB.dists[i] !== dFilter) continue;
            if (!showOutlier && DB.outliers[i] === 1) continue;
            matched.push(i);
        }
        matched.sort((a, b) => DB.times[a] - DB.times[b]);

        if (!showDup) {
            const uniqueMatched = [];
            const seenHorses = new Set();
            for (let i = 0; i < matched.length; i++) {
                const idx = matched[i];
                const name = DB.names[idx];
                if (!seenHorses.has(name)) {
                    seenHorses.add(name);
                    uniqueMatched.push(idx);
                }
            }
            matched = uniqueMatched;
        }
        
        currentRankMap.clear();
        matched.forEach((dbIdx, rank) => {
            currentRankMap.set(dbIdx, rank + 1);
        });
        
        let nameCounts = {};
        matched.forEach(i => {
            let n = DB.names[i];
            nameCounts[n] = (nameCounts[n] || 0) + 1;
        });

        renderList(matched, 'searchList', false, nameCounts);
    }

    function renderList(indices, targetId, isRank, nameCounts = {}) {
        const c = document.getElementById(targetId); c.innerHTML = '';
        if (indices.length === 0) { c.innerHTML = '<div style="text-align:center;padding:20px;">è©²å½“ãªã—</div>'; return; }
        
        indices.forEach((idx, i) => {
            const dateInt = DB.dates[idx];
            const y = Math.floor(dateInt/10000);
            const m = Math.floor((dateInt%10000)/100);
            const d = dateInt%100;
            const dateStr = `${y}å¹´${m}æœˆ${d}æ—¥`;
            
            const placeStr = Dicts.place.list[DB.places[idx]];
            const trackStr = Dicts.track.list[DB.tracks[idx]];
            const condStr = Dicts.cond.list[DB.conditions[idx]];
            const isOut = (DB.outliers[idx] === 1);
            
            const name = DB.names[idx];
            const jockey = DB.jockeys[idx] || "";
            
            let displayColor = 'black';
            if (nameCounts[name] && nameCounts[name] > 1) {
                displayColor = getHorseColor(name);
            }

            const div = document.createElement('div');
            div.className = 'record-item';
            let rh = '';
            if (isRank) {
                let rc = 'rank-other';
                if (i===0) rc='rank-1'; else if(i===1) rc='rank-2'; else if(i===2) rc='rank-3';
                rh = `<div class="rank-badge ${rc}">${i+1}</div>`;
            }
            
            div.innerHTML = `
                <div style="display:flex;align-items:center;">
                    ${rh}
                    <div>
                        <span class="horse-name" style="color:${displayColor}" onclick="showHorseHistory('${name}', event)">${name}</span>
                        <div class="meta-info">${dateStr} (${placeStr}) <span class="jockey-name">(${jockey})</span></div>
                        <div style="font-weight:bold; font-size:0.8rem; margin-top:2px;">${trackStr} ${DB.dists[idx]}m</div>
                    </div>
                </div>
                <div style="text-align:right;">
                    <div class="time-str ${isOut?'outlier':''}" style="color:${displayColor}">${DB.time_strs[idx]}</div>
                    <div class="condition">${condStr}/${DB.ranks[idx]}ç€</div>
                </div>`;
            c.appendChild(div);
        });
    }

    document.getElementById('updateFile').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if(!file) return;
        mergedContentBlob = file; 
        document.getElementById('updateResult').innerHTML = "æº–å‚™OK (â€»æ—¢å­˜ãƒ‡ãƒ¼ã‚¿æœ«å°¾ã«è¿½åŠ ã•ã‚Œã¾ã™)";
        document.getElementById('mergeActionArea').classList.remove('hidden');
    });

    function saveMergedToDB() {
        if(!mergedContentBlob) return;
        const tx = db.transaction([STORE_NAME], 'readwrite');
        const store = tx.objectStore(STORE_NAME);
        store.get('mainCSV').onsuccess = function(e) {
            const oldData = e.target.result;
            let newBlob;
            if (oldData && oldData.content) {
                newBlob = new Blob([oldData.content, "\n", mergedContentBlob], {type: 'text/csv'});
            } else { newBlob = mergedContentBlob; }
            
            const data = { id: 'mainCSV', content: newBlob, fileName: "merged.csv", date: new Date().toLocaleString() };
            store.put(data).onsuccess = function() {
                alert("ä¿å­˜ã—ã¾ã—ãŸã€‚ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦åæ˜ ã—ã¾ã™ã€‚");
                location.reload();
            };
        };
    }

    function downloadMergedCSV() {
        if(!db) return;
        const tx = db.transaction([STORE_NAME], 'readonly');
        tx.objectStore(STORE_NAME).get('mainCSV').onsuccess = function(e) {
            const res = e.target.result;
            if(res && res.content) {
                const url = URL.createObjectURL(res.content);
                const a = document.createElement("a");
                a.href = url; a.download = "app_data_full.csv";
                document.body.appendChild(a); a.click(); document.body.removeChild(a);
            } else { alert("ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“"); }
        };
    }

    function switchTab(n) {
        document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
        document.querySelectorAll('.content').forEach(c=>c.classList.remove('active'));
        document.getElementById(n).classList.add('active');
        if(n==='ranking') document.querySelectorAll('.tab')[0].classList.add('active');
        else if(n==='search') document.querySelectorAll('.tab')[1].classList.add('active');
        else document.querySelectorAll('.tab')[2].classList.add('active');
    }
</script>
</body>
</html>